---
title: Azure SQL Database 台帳の概要
description: Azure SQL Database 台帳の概要
ms.custom: ''
ms.date: 05/25/2021
ms.service: sql-database
ms.subservice: security
ms.reviewer: vanto
ms.topic: conceptual
author: JasonMAnderson
ms.author: janders
ms.openlocfilehash: e74b4ed5b54a27b13768c19878331a9779bb9dc6
ms.sourcegitcommit: 80d311abffb2d9a457333bcca898dfae830ea1b4
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/26/2021
ms.locfileid: "110456845"
---
# <a name="azure-sql-database-ledger"></a>Azure SQL Database 台帳

[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

> [!NOTE]
> 現在、Azure SQL Database 台帳は **パブリック プレビュー** 段階にあります。

データベース システムに格納されているデータの整合性に関する信頼を確立することは、財務、医療、その他の機密データを管理するすべての組織にとって長年の問題でした。 [Azure SQL Database](sql-database-paas-overview.md) の台帳機能により、データベースに改ざん証拠機能が提供され、データが改ざんされていないことを、監査者や他のビジネス関係者などの他の関係者に対して、暗号学的に証明できます。

台帳は、攻撃者、またはデータベース管理者 (DBA) やシステムおよびクラウド管理者を含む高い特権を持つユーザーからデータを保護するのに役立ちます。 従来の台帳と同様に、履歴データは保持されるため、データベースで行が更新された場合、その前の値は履歴テーブルに維持され、保護されます。 台帳には、時間の経過とともにデータベースに加えられたすべての変更の記録が表示されます。 台帳と履歴データは透過的に管理され、アプリケーションを変更せずに保護を提供します。 履歴データは、監査、フォレンジクス、その他の目的で SQL クエリをサポートするためにリレーショナル形式で維持されます。 台帳は、Azure SQL Database の機能、柔軟性、パフォーマンスを維持しつつ、暗号化データの整合性が保証します。

:::image type="content" source="media/ledger/ledger-table-architecture.png" alt-text="台帳テーブルのアーキテクチャ":::

## <a name="use-case-for-azure-sql-database-ledger"></a>Azure SQL Database 台帳のユース ケース 

### <a name="streamlining-audits"></a>監査の合理化

実稼働システムの値は、システムが消費および生成しているデータを信頼する機能に基づいています。 データベース内のデータが悪意のあるユーザーによって改ざんされた場合、そのデータに依存するビジネス プロセスに致命的な結果が生じる可能性があります。 データに対する信頼を維持するには、潜在的な攻撃を減らすための適切なセキュリティ制御の有効化、バックアップと復元の実践、および徹底的なディザスター リカバリー手順の組み合わせが必要です。 これらの慣行を確実に実施しているかが、多くの場合、外部の関係者によって監査されます。 監査プロセスは、非常に時間のかかる作業です。 監査には、数例を挙げてみると、監査ログの確認、認証およびアクセス制御の検査など、実装された慣行のオンサイト検査が必要です。 これらの手動プロセスは、セキュリティの潜在的なギャップを明らかにする可能性はありますが、データが悪意をもって変更されていないという証明を提供することができません。 台帳は、監査者にデータの整合性の暗号化された証明を提供します。これは、監査プロセスを合理化するだけでなく、システムのデータの整合性に関する否認防止も提供します。

### <a name="multi-party-business-processes"></a>マルチパーティーのビジネス プロセス

サプライチェーン管理システムなど、複数の組織が相互に状態を共有する必要のあるビジネス プロセスを持っているシステムでは、データを相互に共有して信頼する方法が課題となっています。 多くの組織は、マルチパーティー ビジネス プロセスをデジタル変換するために、Ethereum や Hyperledger Fabric などの従来のブロックチェーンに目を向けています。 ブロックチェーンは、ネットワークに参加しているパーティー間での信頼が低いようなマルチパーティー ネットワーク向けに優れたソリューションです。 しかし、これらのネットワークの多くは、信頼が重要な、基本的に一元化されたソリューションですが、完全に分散されたインフラストラクチャは、高負荷なソリューションです。 台帳は、ネットワーク コンセンサスがブロックチェーン ネットワークにもたらす複雑さとパフォーマンスへの影響ではなく、一元管理されたデータの整合性を参加者が検証できるようなこれらのネットワークにソリューションを提供します。

### <a name="trusted-off-chain-storage-for-blockchain"></a>ブロックチェーン用の信頼できるオフチェーン ストレージ

マルチパーティーのビジネス プロセスにブロックチェーン ネットワークが必要な場合、パフォーマンスを犠牲にせずにブロックチェーン上のデータをクエリする機能を持つことが課題です。 この問題を解決するための一般的なパターンでは、ブロックチェーンからデータベースなどのオフチェーン ストアにデータをレプリケートします。 ただし、ブロックチェーンからデータベースにデータがレプリケートされると、データの整合性によってブロックチェーンのオファーが失われることが保証されます。 台帳は、ブロックチェーン ネットワークのオフチェーン ストレージに必要なデータ整合性を提供し、システム全体を通じて完全なデータ信頼を確保します。

## <a name="how-it-works"></a>しくみ

データベースによって受信された各トランザクションは、暗号化されてハッシュされます (SHA-256)。 ハッシュ関数は、トランザクションの値 (トランザクションに含まれる行のハッシュを含む) と、ハッシュ関数への入力として以前のトランザクションのハッシュを使用します。 関数は、ブロックチェーンと同様に、すべてのトランザクションを暗号的にリンクします。 データベースの状態を表す暗号化ハッシュ ([データベース ダイジェスト](#database-digests)) は、定期的に生成され、Azure SQL Database 外部にある改ざん防止の保存場所に格納されます。 保存場所の例としては、[Azure Storage 不変 BLOB](../../storage/blobs/storage-blob-immutable-storage.md) または [Azure Confidential Ledger](/azure/confidential-ledger/) があります。 その後、データベース ダイジェストを使用して、ダイジェスト内のハッシュの値をデータベース内の計算されたハッシュと比較することにより、データベースの整合性を検証します。 

台帳機能は、次の 2 つの形式 Azure SQL Database テーブルに導入されます。

- テーブル内の行を更新および削除できる、[**更新可能な台帳テーブル**](ledger-updatable-ledger-tables.md)。
- テーブルへの挿入のみを許可する [**追加専用の台帳テーブル**](ledger-append-only-ledger-tables.md)。

**更新可能な台帳テーブル** と **追加専用の台帳テーブル** の両方で、改ざん防止機能とデジタル フォレンジクス機能が提供されます。 改ざんの可能性のあるイベントを修復する場合、またはシステムに送信されたトランザクションが許可されているユーザーによって行われていることを第三者に証明する場合、データベースに変更を加えたユーザーによって送信されたトランザクションを理解することが重要です。 台帳機能を使用することで、ユーザー、パートナー、または監査者は、すべての履歴操作を分析し、潜在的な改ざんを検出することができます。 各行の操作には、それを実行したトランザクションの ID が付けられます。これにより、ユーザーは、トランザクションが実行された時間とトランザクションを実行したユーザーのIDに関する詳細情報を取得し、このトランザクションによって実行された他の操作と関連付けることができます。

台帳テーブルには、いくつかの制限があることに留意してください。 台帳テーブルの制限の詳細については、「[Azure SQL Database 台帳の制限事項](ledger-limits.md)」を参照してください。

### <a name="ledger-database"></a>台帳データベース

台帳データベースは、すべてのユーザーデータが改ざんされていないことがわかり、台帳テーブルに格納されているデータベースです。 台帳データベースには、台帳テーブルのみを含めることができ、各テーブルは既定では更新可能な台帳テーブルとして作成されます。 台帳データベースは、すべてのデータの整合性を保護する必要があるアプリケーションに使いやすいソリューションを提供します。 

### <a name="updatable-ledger-tables"></a>更新可能な台帳テーブル

[更新可能な台帳テーブル](ledger-updatable-ledger-tables.md)は、レコードのシステム (SOR) アプリケーションなどのデータベース内のテーブルに対して更新と削除を実行するアプリケーション パターンに最適です。 これは、アプリケーションの既存のデータ パターンを変更して、台帳機能を有効にする必要がないことを意味します。  

[更新可能な台帳テーブル](ledger-updatable-ledger-tables.md)では、更新または削除を実行するトランザクションが発生したときに、データベース内の行への変更の履歴を追跡します。 更新可能な台帳テーブルは、システムによってバージョン管理されたテーブルであり、ミラー化されたスキーマを持つ別のテーブルへの参照が含まれています。 システムでは、このテーブルを使用して、台帳テーブルの行が更新または削除されるたびに、行の以前のバージョンを自動的に保存します。 このもう 1 つのテーブルは、履歴テーブルと呼ばれます。 履歴テーブルは、更新可能な台帳テーブルが作成されると自動的に作成されます。 更新可能な台帳テーブルとそれに対応する履歴テーブルに含まれる値は、時間の経過に伴うデータベースの値の記録を提供します。 データベースのこの記録を簡単に照会するために、システムによって生成された台帳ビューが作成されます。これは、更新可能な台帳テーブルと履歴テーブルを結合します。

更新可能な台帳テーブルを作成して使用する方法の詳細については、「[更新可能な台帳テーブルを作成して使用する](ledger-how-to-updatable-ledger-tables.md)」を参照してください。

### <a name="append-only-ledger-tables"></a>追加専用の台帳テーブル

[追加専用の台帳テーブル](ledger-append-only-ledger-tables.md)は、セキュリティ情報イベント管理 (SIEM) アプリケーションなど、挿入専用のアプリケーション パターンに最適です。 追加専用の台帳テーブルは、アプリケーション プログラミング インターフェイス (API) レベルで更新と削除をブロックし、システム管理者や DBA などの特権ユーザーからの改ざん防止をさらに提供します。 システムに許可されるのは挿入のみなであり、キャプチャする履歴がないため、追加専用の台帳テーブルには対応する履歴テーブルはありません。 更新可能な台帳テーブルと同様に、追加専用のテーブルに行を挿入したトランザクションと、挿入を実行したユーザーに関する分析情報を提供する台帳ビューが作成されます。

追加専用の台帳テーブルを作成して使用する方法の詳細については、「[追加専用の台帳テーブルを作成して使用する](ledger-how-to-append-only-ledger-tables.md)」を参照してください。

### <a name="database-ledger"></a>データベース台帳

データベース台帳は、システムで処理されたトランザクションの暗号化ハッシュを格納するシステム テーブルで構成されます。 トランザクションはデータベース エンジンの[原子性](/windows/win32/cossdk/acid-properties)の単位であるため、これはデータベース台帳にキャプチャされる作業単位です。 具体的には、トランザクションがコミットされると、台帳テーブル内でトランザクションによって変更された行の SHA-256 ハッシュが、トランザクションを実行したユーザーの ID やコミット タイムスタンプなどのトランザクションのメタデータとともに、*トランザクション エントリ* としてデータベース台帳に追加されます。 30 秒ごとに、データベースによって処理されるトランザクションは、Merkle ツリー データ構造を使用して SHA-256 ハッシュされ、ルート ハッシュが生成されます。 これにより、ブロックが形成されます。その後、ブロックのルート ハッシュと、ハッシュ関数への入力として以前のブロックのルート ハッシュを使用して SHA-256 ハッシュされ、ブロックチェーンが形成されます。

データベース台帳の詳細については、「[データベース台帳](ledger-database-ledger.md)」を参照してください。

### <a name="database-digests"></a>データベース ダイジェスト

データベース台帳における最新のブロックのハッシュは、データベースのダイジェストと呼ばれ、ブロックが生成された時点のデータベース内のすべての台帳テーブルの状態を表します。 ブロックが形成されると、それに関連付けられているデータベース ダイジェストが公開され、Azure SQL Database の外部の改ざん防止ストレージに格納されます。 データベース ダイジェストは、生成された時点のデータベースの状態を表しているため、ダイジェストを改ざんから保護することは最も重要です。 ダイジェストを変更するアクセス権を持つ攻撃者は、データベース内のデータを改ざんし、改ざんされた変更でデータベースを表すハッシュを生成し、ブロック内のトランザクションの更新されたハッシュを表すようにダイジェストを変更することができます。 台帳を使用すると、データベース ダイジェストを自動的に生成して、[Azure Storage 不変 BLOB](../../storage/blobs/storage-blob-immutable-storage.md) や [Azure Confidential Ledger](/azure/confidential-ledger/) に格納し、改ざんを防ぐことができます。 また、ユーザーが手動でデータベース ダイジェストを生成し、それらを選択した場所に格納することもできます。 データベース ダイジェストは、台帳テーブルに格納されているデータが改ざんされていないことを確認するために、後で使用されます。

データベース ダイジェストの詳細については、「[ダイジェストの管理とデータベースの検証](ledger-digest-management-and-database-verification.md)」を参照してください。

### <a name="ledger-verification"></a>台帳の検証

台帳機能では、ユーザーが台帳のコンテンツを変更することはできません。 しかし、コンピューターを制御している攻撃者やシステム管理者は、すべてのシステム チェックをバイパスし、データを直接改ざんすることができます。 たとえば、攻撃者またはシステム管理者は、ストレージ内のデータベース ファイルを編集できます。 台帳は、このような攻撃を防ぐことはできませんが、台帳データを検証すると、改ざんが検出されることは保証されています。 台帳検証プロセスは、以前に生成された 1 つ以上のデータベース ダイジェストを入力として受け取り、現在の台帳テーブルの状態に基づいて、データベース台帳に格納されているハッシュを再度計算します。 計算されたハッシュが入力ダイジェストと一致しない場合、検証は失敗し、データが改ざんされていることを示し、検出されたすべての不一致を報告します。

台帳の検証では、データベース内のトランザクションのすべてのハッシュが再計算されるので、大量のデータを含むデータベースではリソースを大量に消費するプロセスになる可能性があります。 台帳の検証は、ユーザーが継続的にではなく、データベースの整合性を検証する必要がある場合にのみ実行する必要があります。 理想的には、台帳の検証は、データをホストする組織が監査を受け、データの整合性に関する暗号化された証拠を別の関係者に提供する必要がある場合にのみ実行することです。 検証コストを削減するために、台帳では、個々の台帳テーブル、または台帳の一部のみを検証するオプションが公開されています。

台帳の検証の詳細については、「[ダイジェストの管理とデータベースの検証](ledger-digest-management-and-database-verification.md)」を参照してください。

## <a name="next-steps"></a>次の手順
 
- [クイックスタート: 台帳が有効化された Azure SQL Database を作成する](ledger-create-a-single-database-with-ledger-enabled.md)
- [更新可能な台帳テーブル](ledger-updatable-ledger-tables.md)   
- [追加専用台帳テーブル](ledger-append-only-ledger-tables.md)   
- [データベース台帳](ledger-database-ledger.md)   
- [ダイジェストの管理とデータベースの検証](ledger-digest-management-and-database-verification.md)   
- [Azure SQL Database 台帳の制限事項](ledger-limits.md)
- [更新可能な台帳テーブルを作成して使用する](ledger-how-to-updatable-ledger-tables.md)
- [追加専用台帳テーブルを作成、使用する](ledger-how-to-append-only-ledger-tables.md)
- [Azure Confidential Ledger (ACL) に保存されたダイジェストにアクセスする方法](ledger-how-to-access-acl-digest.md)
- [台帳テーブルを検証して改ざんを検出する方法](ledger-verify-database.md)
