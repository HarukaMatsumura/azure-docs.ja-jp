---
title: 拡張事前/事後スクリプト フレームワークを使用したデータベース整合性スナップショット
description: Azure VM バックアップを利用し、パッケージ化された事前/事後スクリプトを使用して、Microsoft Azure Backup がデータベース整合性スナップショットを作成する方法について説明します
ms.topic: conceptual
ms.date: 09/01/2021
ms.custom: devx-track-azurepowershell
ms.openlocfilehash: 5b53a85521188a876b7a0d7368245c9d28910f39
ms.sourcegitcommit: add71a1f7dd82303a1eb3b771af53172726f4144
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/03/2021
ms.locfileid: "123440123"
---
# <a name="enhanced-pre-post-scripts-for-database-consistent-snapshot"></a>データベース整合性スナップショットのための拡張事前/事後スクリプト

Microsoft Azure Backup サービスには、Microsoft Azure Backup を使用して Linux VM がアプリケーションの整合性を実現するための [_事前/事後_ スクリプト フレームワーク](/azure/backup/backup-azure-linux-app-consistent)が既に提供されています。 これには、ディスクのスナップショットを作成する前に (アプリケーションを停止するために) 事前スクリプトを呼び出すことと、アプリケーションを通常モードに戻すためにスナップショットの完了後に事後スクリプト (アプリケーションを停止解除するためのコマンド) を呼び出すことが含まれます。 お客様は、これらの事前/事後スクリプトを作成し、`etc/azure` ディレクトリ内の *VMSnapshotScriptPluginConfig.json* ファイルの関連情報を提供する必要があります。 しかし、お客様は、独自のスクリプトの作成、デバッグ、保守に関する懸念があり、それらの労力をオーバーヘッドと考えました。 そのため、Microsoft Azure Backup では、ユーザーが追加のオーバーヘッドを発生させずにアプリケーション整合性スナップショットを毎日取得できるように、データベースをマーキーするための _拡張_ 事前/事後スクリプト エクスペリエンスを提供することを決定しました。 

新しい "拡張" 事前/事後スクリプト フレームワークの主な利点を次に示します。

- これらの事前/事後スクリプトは、バックアップ拡張機能と共に Azure VM に直接インストールされます。 それらを作成する必要はなく、外部の場所からダウンロードする懸念はありません。
- 引き続き、[GitHub](https://github.com/Azure/azure-linux-extensions/tree/master/VMBackup/main/workloadPatch/DefaultScripts) 内で事前/事後スクリプトの定義またはコンテンツを表示できます。 変更を送信すると、Microsoft Azure Backup チームが必要に応じて変更内容を検証、確認、マージし、すべてのユーザーが恩恵を受けられるようにできます。
- また、[GitHub](https://github.com/Azure/azure-linux-extensions/tree/master/VMBackup/main/workloadPatch/DefaultScripts) を介して他のデータベース用の新しい事前/事後スクリプトを追加することもできます。 十分な情報とテストを行って、Microsoft Azure Backup チームはそれらをマージし、すべてのユーザーに提供することを選択できます。
- 現在このフレームワークは、事前スクリプト実行の失敗やクラッシュなどのシナリオに対処する堅牢な機能を備えます。 どのような場合も、事前スクリプトで行われたすべての変更をロールバックするために、事後スクリプトが確実に呼び出されます。
- また、このフレームワークでは、外部ツールがリッスンし、任意のメッセージまたはイベントに対して独自のアクション プランを準備するための _メッセージング_ チャネルも提供されます。

## <a name="support-matrix"></a>サポート マトリックス

拡張フレームワークの対象となるデータベースの一覧を次に示します。

- [Oracle (プレビュー)](/azure/virtual-machines/workloads/oracle/oracle-database-backup-azure-backup)
- MySQL (プレビュー)

## <a name="prerequisites"></a>前提条件

構成ファイル *workload.conf* を `/etc/azure` 内で編集し、接続情報を指定するだけで、Microsoft Azure Backup が関連するアプリケーションに接続して事前スクリプトと事後スクリプトを実行できます。 構成ファイルには、次のパラメーターがあります。

```json
[workload]
# valid values are mysql, oracle
workload_name =
command_path = 
linux_user =
credString = 
ipc_folder = 
timeout =
```

これらのパラメーターについて、次に説明します。

|パラメーター  |Mandatory  |説明  |
|---------|---------|---------|
|workload_name     |   yes      |     これには、アプリケーション整合性バックアップを実行する必要があるデータベースの名前が指定されます。 現在サポートされる値は `oracle` または `mysql` です。    |
|command_path/configuration_path     |         |   これには、ワークロード バイナリへのパスが指定されます。 ワークロード バイナリがパス変数として設定されている場合、これは必須フィールドではありません      |
|linux_user     |    yes     |   これは、データベース ユーザー ログインへのアクセス許可がある linux_user のユーザー名が指定されます。 この値が設定されていない場合、root が既定のユーザーと見なされます。      |
|credString     |         |     これは、データベースに接続するための資格情報文字列の略です。 これにはログイン文字列全体が指定されます    |
|ipc_folder     |         |   ワークロードは、特定のファイル システム パスにのみ書き込み可能です。 事前スクリプトがこのファイル パスにいくつかの状態を書き込むには、このフォルダー パスをここで指定する必要があります。      |
|timeout     |    yes     |     これは、データベースが休止処理状態になるまでの最大時間です。 既定値は 90 秒です。 60 秒未満の値を設定することは推奨されません    |

> [!NOTE]
> JSON 定義は、Microsoft Azure Backup サービスが特定のデータベースに合わせて変更できるテンプレートです。 各データベースの構成ファイルを理解するには、[各データベースの詳細なマニュアル](#support-matrix)を参照してください。

全体的に、拡張事前/事後スクリプト フレームワークを使用するカスタマー エクスペリエンスは次のとおりです。

- データベース環境を準備する
- 構成ファイルを編集する
- VM のバックアップをトリガーする
- 必要に応じて、アプリケーション整合性復旧ポイントから VM、ディスク、またはファイルを復元します。

## <a name="build-a-database-backup-strategy"></a>データベース バックアップ戦略を構築する

### <a name="using-snapshots-instead-of-streaming"></a>ストリーミングでなくスナップショットの使用

通常、ストリーミング バックアップ (完全バックアップ、差分バックアップ、増分バックアップなど) とログは、バックアップ戦略でデータベース管理者によって使用されます。 設計における重要なピボットまたは懸念事項の一部を次に示します。

- **パフォーマンスとコスト**: 毎日の完全バックアップとログ作成は、復元時間が最も高速ですが、かなりのコストがかかります。 差分バックアップまたは増分バックアップを含めることで、コストは低減しますが、復元のパフォーマンスに影響を与える可能性があります。
- **データベースまたはインフラストラクチャへの影響**: ストリーミング バックアップのパフォーマンスは、基になるストレージ IOPS と、ストリームのトリガー時にリモートの場所で使用できるネットワーク帯域幅によって異なります。
- **再使用性**: さまざまなストリーミング バックアップの種類をトリガーするコマンドは、データベースごとに異なります。 そのため、スクリプトは簡単には再使用できません。 また、異なるバックアップの種類を使用している場合は、ライフ サイクルを維持するための依存関係チェーンを理解する必要があります。 もちろん、データベース クライアントの一部には、このような側面を処理するものがありますが、そのことは、バックアップ データもこれらのクライアントによって削除されやすいことを意味します。
- **長期保有**: 完全バックアップは、任意の時点で個別に移動して復旧できるので、長期的な保持には確実に有効です。 スナップショットの保持は、迅速な復元に役立つため、ストリーミング バックアップによって発生するパフォーマンスの問題を回避できます。

- **パフォーマンスとコスト**: Azure VM バックアップを介して、インスタント バックアップ、復元、スナップショットを提供し、_増分_ バックアップでもあるため、コスト効率が高くもあります。 復元中に完全バックアップとして機能するスナップショットを使用すると、ストリーミングの完全バックアップと増分バックアップが不要であり、運用バックアップのストレージ コストを節約できます。
- **データベースまたはインフラストラクチャへの影響**: スナップショットは、データベースとインフラストラクチャに与える影響が最も少なくなります。
- **再使用可能性**: データベースごとにスナップショットを作成するために習得する必要があるコマンドは 1 つだけです。 依存関係チェーンは必要ありません。 拡張事前スクリプトがコマンドを処理します。
- **短期保有期間**: 長期保有のためには使用できませんが (基になるストレージとのリンクのため)、短期保有期間と毎日の運用バックアップに最適です。
 
重要な要件として、スナップショットの前後に、凍結と解凍を行う適切なコマンドを使用してデータベースが関係していることを確認し、事前/事後スクリプトでそれらが処理されるようにすることがあります。

### <a name="log-backup-strategy"></a>ログ バックアップ戦略

拡張事前/事後スクリプト フレームワークは、1 日に 1 回バックアップをスケジュールする Azure VM バックアップ上に構築されています。 そのため、RPO の 24 時間のデータ損失期間は、実稼働データベースでは許容されません。 このソリューションは、ログ バックアップが明示的にストリーミングされるログ バックアップ戦略によって補完される必要があります。 [BLOB での NFS](/azure/storage/blobs/network-file-system-protocol-support) と [AFS (プレビュー) での NFS](/azure/storage/files/files-nfs-protocol) の出現により、データベース VM にボリュームを直接マウントし、データベース クライアントを使用してログ バックアップを転送する方が簡単になりました。 RPO であるデータ損失期間は、ログ バックアップの頻度まで低下します。 また、これらの NFS ターゲットは高パフォーマンスである必要はありません。前述のように、データベース整合性スナップショットを取得した後に、運用バックアップのために定期的なストリーミング (完全と増分) をトリガーする必要が生じない可能性があるためです。

>[!NOTE]
>通常拡張事前スクリプトが、スナップショットを取得するためにデータベースを休止処理する前に、転送中のすべてのログ トランザクションをログ バックアップ先にフラッシュする処理を行います。 つまり、スナップショットは、データベースとの整合性があり、復旧中の信頼性があるはずです。

### <a name="recovery-strategy"></a>復旧戦略

データベース整合性スナップショットが作成され、ログ バックアップが NFS ボリュームにストリーミングされると、データベースの復旧戦略では、Azure VM バックアップの復旧機能を利用でき、その上にデータベース クライアントを使用してログ バックアップを適用する能力が備わります。 復旧戦略のいくつかのオプションを次に示します。

- データベース整合性復旧ポイントから新しい VM を作成します。 VM にはログ マウント ポイントが既に存在し、それに接続されている必要があります。 データベース クライアントを使用して、ログの特定の時点に復旧するためのコマンドを実行します。
- データベース整合性復旧ポイントからディスクを作成します。 別のターゲット VM に接続します。 次に、ログの宛先をマウントし、データベース クライアントを使用して特定の時点に復旧するための復旧コマンドを実行します
- ファイルの復旧オプションを使用し、スクリプトを生成します。 ターゲット VM でスクリプトを実行し、復旧ポイントを iSCSI ディスクとして接続します。 データベース クライアントを使用して、接続されているディスクでデータベース固有の検証関数を実行し、バックアップ データを検証します。 また、データベース クライアントを使用して、データベース全体を復旧するのでなく、少数のテーブルまたはファイルをエクスポートまたは復旧します。
- リージョン内災害時には、リージョンをまたがる復元機能を使用して、セカンダリ ペア リージョンから上記のアクションのすべて、またはいずれかを実行します。

## <a name="summary"></a>まとめ

データベース整合性スナップショットと、カスタム ソリューションを使用してバックアップされたログを使用すると、Azure VM バックアップのメリットを活用し、データベース クライアントの機能を再利用するパフォーマンスとコスト効率に優れたデータベース バックアップ ソリューションを構築できます。

