---
title: Anomaly Detector Multivariate API の使用に関するベスト プラクティス
titleSuffix: Azure Cognitive Services
description: Anomaly Detector Multivariate API を使用して時系列データに異常検出を適用するためのベスト プラクティス。
services: cognitive-services
author: mrbullwinkle
manager: nitinme
ms.service: cognitive-services
ms.subservice: anomaly-detector
ms.topic: conceptual
ms.date: 04/01/2021
ms.author: mbullwin
keywords: 異常検出, 機械学習, アルゴリズム
ms.openlocfilehash: 30778cf48efda57fc0d50964611d5616ce7a84d5
ms.sourcegitcommit: 17345cc21e7b14e3e31cbf920f191875bf3c5914
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/19/2021
ms.locfileid: "110062256"
---
# <a name="multivariate-time-series-anomaly-detector-best-practices"></a>時系列の Anomaly Detector Multivariate でのベスト プラクティス

この記事では、Anomaly Detector Multivariate API を使用する際の推奨プラクティスに関するガイダンスを提供します。

## <a name="training-data"></a>トレーニング データ 

### <a name="data-schema"></a>データ スキーマ
Anomaly Detector 多変量 API シリーズを使用するには、最初に独自のモデルをトレーニングする必要があります。 トレーニング データは、次の要件を満たす複数の時系列のセットです。

各時系列は、ヘッダー行として **"timestamp"** と **"value"** (すべて小文字) の 2 つの列のみを含む CSV ファイルである必要があります。 "timestamp" の値は、ISO 8601 に準拠している必要があります。"value" は、整数または小数点以下の桁数が任意の小数にすることができます。 次に例を示します。

|timestamp | value|
|-------|-------|
|2019-04-01T00:00:00Z| 5|
|2019-04-01T00:01:00Z| 3.6|
|2019-04-01T00:02:00Z| 4|
|`...`| `...` |

各 CSV ファイルには、モデルのトレーニングに使用する異なる変数に基づいて名前を付ける必要があります。 たとえば、"temperature.csv" や "humidity.csv" などです。 すべての CSV ファイルは、サブフォルダーを使用しないで 1 つの ZIP ファイルに圧縮する必要があります。 ZIP ファイルには任意の名前を付けることができます。 ZIP ファイルは Azure Blob Storage にアップロードする必要があります。 その ZIP ファイルの [BLOB SAS (Shared Access Signature) URL](../../../storage/common/storage-sas-overview.md) を生成したら、それをトレーニングに使用できます。 Azure Blob Storage から SAS URL を生成する方法については、このドキュメントを参照してください。

### <a name="data-quality"></a>データ品質
- モデルは、履歴データから標準パターンを学習するので、トレーニング データは **システムの全体的な標準状態** を表している必要があります。 モデルがこの種のパターンを学習するのは、トレーニング データに異常がいっぱい含まれている場合は困難です。 
-  モデルには数百万のパラメーターがあり、最適なパラメーター セットを学習するために最低限のデータ ポイントが必要です。 一般的には、モデルを適切にトレーニングするには、**変数ごとに少なくとも 15,000 個** のデータ ポイントを提供する必要があります。 データの量が多いほど、モデルの質が向上します。
- 一般に、**トレーニング データの欠損値比率は 20% 未満である必要があります**。 欠落しているデータが多すぎると、自動的に塗りつぶされた値 (通常、直線のセグメントや定数値) が標準パターンであると見なされる可能性があります。 これにより、実際のデータ ポイントが異常として検出される可能性があります。 

    ただし、高い比率が許容される場合もあります。 たとえば、`Outer` モードを使用してタイムスタンプを揃えるグループに 2 つの時系列があるとします。 1 つは 1 分間の細分性で、もう 1 つは 1 時間単位の細分性です。 そのとき、時間単位の時系列は、59/60 = 98.33% のデータポイントが不足しています。 このような場合、時間単位の時系列が頻繁に変動しない場合にのみ使用可能な値を、1 時間ごとの時系列に入力しても問題はありません。

## <a name="parameters"></a>パラメーター

### <a name="sliding-window"></a>スライディング ウィンドウ

多変量の異常検出では、`slidingWindow` の長さのデータ ポイントのセグメントを入力として取り、次のデータ ポイントが異常かどうかを判断します。 サンプルの長さが長いほど、決定に際して、より多くのデータが考慮されます。 `slidingWindow` に適切な値を選択するときに留意すべき 2 つの事柄があります。入力データのプロパティと、トレーニングまたは推論にかかる時間と潜在的なパフォーマンス向上との間のトレードオフです。 `slidingWindow` は、28 から 2880 までの整数で構成されます。 データが周期的であるかどうか、およびデータのサンプリング レートに基づいて、入力として使用されるデータ ポイントの数を決めることができます。

データが周期的な場合は、1 から 3 サイクルを入力として含めることができます。また、データのサンプリングが、分レベルまたは秒レベルのデータなど、高頻度 (小さい細分性) で行われる場合は、さらに多くのデータを入力として選択できます。 もう 1 つの問題は、入力が長いとトレーニングまたは推論の時間も長くなる可能性があり、入力ポイントの増加がパフォーマンス向上につながるという保証はないという点です。 一方で、データ・ポイントの数が少なすぎると、モデルを最適解に収束させるのが困難になる可能性があります。 たとえば、入力データに 2 つのポイントしかない場合、異常を検出するのは困難です。

### <a name="align-mode"></a>配置モード

パラメーター `alignMode` は、複数の時系列をタイムスタンプに沿って配置する方法を指示するために使用されます。 これは、多くの時系列に欠損値があり、さらなる処理を行う前に同じタイムスタンプ上にそれらを配置する必要があるためです。 このパラメーターには、`inner join` と `outer join` という 2 つのオプションがあります。 `inner join` は、**すべての時系列** に値があるタイムスタンプで検出結果を報告することを意味します。一方、`outer join` は、値がある **任意の時系列** のタイムスタンプで検出結果を報告することを意味します。  **`alignMode` も、モデルの入力シーケンスに影響します**。したがって、結果が大幅に異なる可能性があるので、実際のシナリオに適した `alignMode` を選択してください。

ここでは、異なる `alignModel` 値を説明するために例を示します。

#### <a name="series1"></a>Series1

|timestamp | value|
----------| -----|
|`2020-11-01`| 1  
|`2020-11-02`| 2  
|`2020-11-04`| 4  
|`2020-11-05`| 5

#### <a name="series2"></a>Series2

timestamp | value  
--------- | -
`2020-11-01`| 1  
`2020-11-02`| 2  
`2020-11-03`| 3  
`2020-11-04`| 4

#### <a name="inner-join-two-series"></a>2 つの系列の内部結合
  
timestamp | Series1 | Series2
----------| - | -
`2020-11-01`| 1 | 1
`2020-11-02`| 2 | 2
`2020-11-04`| 4 | 4

#### <a name="outer-join-two-series"></a>2 つの系列の外部結合

timestamp | series1 | series2
--------- | - | -
`2020-11-01`| 1 | 1
`2020-11-02`| 2 | 2
`2020-11-03`| NA | 3
`2020-11-04`| 4 | 4
`2020-11-05`| 5 | NA

### <a name="fill-not-available-na"></a>Not Available (NA) を埋める

外部結合によってタイムスタンプに変数が配置された後、一部の変数に `Not Available` (`NA`) 値がある場合があります。 この NA 値を埋める方法を指定できます。 `fillNAMethod` のオプションは、`Linear`、`Previous`、`Subsequent`、`Zero`、および `Fixed` です。

| オプション     | Method                                                                                           |
| ---------- | -------------------------------------------------------------------------------------------------|
| Linear     | NA 値を線形補間で埋める                                                           |
| 前へ   | 最後に有効だった値を伝達してギャップを埋める。 例: `[1, 2, nan, 3, nan, 4]` -> `[1, 2, 2, 3, 3, 4]` |
| Subsequent | 次に有効な値を使用して、ギャップを埋める。 例: `[1, 2, nan, 3, nan, 4]` -> `[1, 2, 3, 3, 4, 4]`       |
| ゼロ       | 0 で NA 値を埋める。                                                                           |
| 固定      | `paddingValue` で指定した有効な指定値で NA 値を埋める。          |

## <a name="model-analysis"></a>モデル分析

### <a name="training-latency"></a>トレーニングの遅延

多変量の異常検出トレーニングには、時間がかかることがあります。 トレーニングに使用されるタイムスタンプの量が多い場合は特にそうです。 そのため、トレーニング プロセスの一部を非同期にすることができます。 通常、ユーザーは、Train Model API を使用してトレーニング タスクを送信します。 次に、`Get Multivariate Model API` を使用してモデルの状態を取得します。 ここでは、トレーニングが完了するまでの残り時間を抽出する方法を示します。 Get Multivariate Model API の応答には、`diagnosticsInfo` という名前の項目があります。 この項目には、`modelState` 要素があります。 残り時間を計算するには、`epochIds` と `latenciesInSeconds` を使用する必要があります。 エポックは、トレーニング データの 1 周期全体を表します。 10 エポックごとに、状態情報を出力します。 合計でトレーニングを 100 エポック行います。待機時間は、1 つのエポックの所要時間を示しています。 この情報により、モデルをトレーニングするための残り時間を把握できます。

### <a name="model-performance"></a>モデル パフォーマンス

教師なしモデルとしての多変量の異常検出。 これを評価する最良の方法は、異常結果を手動で確認することです。 Get Multivariate Model の応答では、モデルのパフォーマンスを分析するための基本情報を提供します。 Get Multivariate Model API によって返される `modelState` 要素で、`trainLosses` および `validationLosses` を使用して、モデルが想定されたとおりにトレーニングされているかどうかを評価できます。 ほとんどの場合、この 2 つの損失は徐々に減少します。 モデルのパフォーマンスを分析するためのもう 1 つの情報は、`variableStates` にあります。 変数の状態一覧は、`filledNARatio` によって降順で順位付けされます。 パフォーマンスが低下するほど、通常は、できるだけ `NA ratio` を減らす必要があります。 `NA` の原因としては、欠損値、またはタイムスタンプの観点から整列されていない変数が考えられます。

## <a name="next-steps"></a>次のステップ

- [クイックスタート](../quickstarts/client-libraries-multivariate.md)。
- [Anomaly Detector Multivariate を動かす、基になるアルゴリズムについて説明します](https://arxiv.org/abs/2009.02040)
