---
title: アウトバウンド接続の送信元ネットワーク アドレス変換 (SNAT)
titleSuffix: Azure Load Balancer
description: Azure Load Balancer を送信用インターネット接続 (SNAT) に使用する方法について説明します。
services: load-balancer
author: asudbring
ms.service: load-balancer
ms.topic: conceptual
ms.custom: contperf-fy21q1
ms.date: 07/01/2021
ms.author: allensu
ms.openlocfilehash: 6ca5d85e04cab46292ed51e23f4cd5f2add5dcae
ms.sourcegitcommit: 692382974e1ac868a2672b67af2d33e593c91d60
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/22/2021
ms.locfileid: "130223350"
---
# <a name="using-source-network-address-translation-snat-for-outbound-connections"></a>アウトバウンド接続に送信元ネットワーク アドレス変換 (SNAT) を使用する

特定のシナリオでは、仮想マシンまたはコンピューティング インスタンスからインターネットへのアウトバウンド接続が必要です。 Azure パブリック ロード バランサーのフロントエンド IP を使用して、インターネットへのアウトバウンド接続をバックエンド インスタンスに提供できます。 この構成では、**送信元ネットワーク アドレス変換 (SNAT)** を使用して、仮想マシンのプライベート IP がロード バランサーのパブリック IP アドレスに変換されます。 SNAT では、バックエンドの IP アドレスをロード バランサーのパブリック IP アドレスにマップします。 SNAT によって、外部の送信元はバックエンド インスタンスへの直接アドレスを取得できなくなります。  

## <a name="azures-outbound-connectivity-methods"></a><a name="scenarios"></a>Azure のアウトバウンド接続方法

インターネットへのアウトバウンド接続は、次の方法で有効にできます。

| # | メソッド | ポート割り当ての種類 | 運用環境グレードか? | Rating |
| ------------ | ------------ | ------ | ------------ | ------------ |
| 1 | アウトバウンド規則を使用してアウトバウンド用の Load Balancer のフロントエンド IP アドレスを使用する | 静的、明示的 | はい (ただし大規模ではない) | [OK] | 
| 2 | サブネットへの NAT ゲートウェイの関連付け | 静的、明示的 | はい | 最高 | 
| 3 | 仮想マシンへのパブリック IP の割り当て | 静的、明示的 | はい | [OK] | 
| 4 | アウトバウンド (およびインバウンド) 用の Load Balancer のフロントエンド IP アドレスを使用する | 暗黙 | いいえ | 下から 2番目 |
| 5 | [既定のアウトバウンド アクセス](../virtual-network/ip-services/default-outbound-access.md)を使用する | 暗黙 | いいえ | 最低 |

## <a name="using-the-frontend-ip-address-of-a-load-balancer-for-outbound-via-outbound-rules"></a><a name="outboundrules"></a>アウトバウンド規則を使用してアウトバウンド用のロード バランサーのフロントエンド IP アドレスを使用する

アウトバウンド規則を使用すると、標準パブリック ロード バランサーの SNAT (送信元ネットワーク アドレス変換) を明示的に定義できます。 

この構成では、ロード バランサーのパブリック IP または IP をバックエンド インスタンスのアウトバウンド接続に使用できます。

この構成を使用すると、以下が可能になります。

- IP マスカレード
- 許可リストの単純化
- デプロイのパブリック IP リソース数の削減。

アウトバウンド規則を使用すると、送信インターネット接続を完全に宣言的に制御できます。 アウトバウンド規則を使用すると、特定のニーズに合わせてこの機能をスケーリングおよび調整することができます。

アウトバウンド規則の詳細については、[アウトバウンド規則](outbound-rules.md)に関するページを参照してください。

>[!Important]
> バックエンド プールが IP アドレス別に構成されている場合、既定のアウトバウンドが有効な Basic ロード バランサーとして動作します。 既定でセキュリティで保護された構成の場合と、アウトバウンドのニーズが厳しいアプリケーションの場合は、バックエンド プールを NIC 別に構成します。

## <a name="associating-a-nat-gateway-to-the-subnet"></a>サブネットへの NAT ゲートウェイの関連付け

Virtual Network NAT を使用すると、仮想ネットワークでアウトバウンド専用のインターネット接続が簡単になります。 これをサブネットに対して構成した場合、指定した静的パブリック IP アドレスがすべてのアウトバウンド接続で使用されます。 ロード バランサーや、仮想マシンに直接アタッチされたパブリック IP アドレスがなくても、アウトバウンド接続が可能となります。 NAT はフル マネージドで、高い回復性を備えています。

アウトバウンド接続には、NAT ゲートウェイを使用することが最善の方法です。 NAT ゲートウェイは、高い拡張性と信頼性を備えており、SNAT ポート不足に関する同じ問題はありません。

Azure Virtual Network NAT の詳細については、「[Azure Virtual Network NAT とは](../virtual-network/nat-gateway/nat-overview.md)」を参照してください。

##  <a name="assigning-a-public-ip-to-the-virtual-machine"></a>仮想マシンへのパブリック IP の割り当て

 | Associations | Method | IP プロトコル |
 | ---------- | ------ | ------------ |
 | VM の NIC 上のパブリック IP | [SNAT (送信元ネットワーク アドレス変換)](#snat) </br> は使用されません。 | TCP (伝送制御プロトコル) </br> UDP (ユーザー データグラム プロトコル) </br> ICMP (インターネット制御メッセージ プロトコル) </br> ESP (カプセル化セキュリティ ペイロード) |

 トラフィックは、仮想マシンのパブリック IP アドレス (インスタンス レベル IP) から要求元のクライアントに戻ります。
 
 すべてのアウトバウンド フローについて、インスタンスの NIC の IP 構成に割り当てられたパブリック IP が Azure によって使用されます。 インスタンスには、使用可能なすべてのエフェメラル ポートがあります。 VM が負荷分散されているかどうかは関係ありません。 このシナリオは他のシナリオよりも優先されます。 

 VM に割り当てられたパブリック IP は (1 対多ではなく) 1 対 1 の関係であり、1 対 1 のステートレス NAT として実装されます。

## <a name="using-the-frontend-ip-address-of-a-load-balancer-for-outbound-and-inbound"></a><a name="snat"></a> アウトバウンド (およびインバウンド) 用のロード バランサーのフロントエンド IP アドレスを使用する
>[!NOTE]
> この方法は、ポートの枯渇リスクを高めるため、運用環境のワークロードには **推奨されません**。 SNAT ポートの不足による接続エラーの可能性を避けるために、運用ワークロードにこの方法を使用しないようにしてください。 

ロード バランサーのバックエンドのリソースに以下が存在しない場合、

* アウトバウンド規則
* インスタンス レベル パブリック IP アドレス
* 構成された NAT ゲートウェイ

ロード バランサーのフロントエンド IP 経由でアウトバウンド接続が作成され、既定の SNAT (既定のアウトバウンド アクセスとも呼ばれる) が利用されます。

## <a name="default-outbound-access"></a>既定のアウトバウンド アクセス

リソースに以下が存在しない場合、

* アウトバウンド規則
* インスタンス レベル パブリック IP アドレス
* 構成された NAT ゲートウェイ
* ロード バランサー

既定の SNAT を使用してアウトバウンド接続が作成されます。 これは、既定のアウトバウンド アクセスと呼ばれます。 既定の SNAT を使用するシナリオのもう 1 つの例として、Azure の仮想マシン (前述の関連付けはありません) があります。 この場合、アウトバウンド接続は既定のアウトバウンド アクセス IP によって提供されます。 これは、Azure によって割り当てられた動的 IP であり、ユーザーが制御することはできません。 既定の SNAT は、運用環境のワークロードにはお勧めしません。

### <a name="what-are-snat-ports"></a>SNAT ポートとは

ポートは、個別のフローを維持するために使用される一意の識別子を生成するために使用されます。 インターネットには、この区別を実現するために 5 タプルが使用されます。

あるポートがインバウンド接続に使用されている場合、そのポートでのインバウンド接続要求用の **リスナー** があります。 このポートは、アウトバウンド接続には使用できません。 アウトバウンド接続を確立するには、**エフェメラル ポート** を使用して、通信と個別のトラフィック フローの維持に使用するポートを宛先に提供します。 このエフェメラル ポートが SNAT に使用される場合、**SNAT ポート** と呼ばれます。

定義上、すべての IP アドレスには 65,535 個のポートがあります。 各ポートは、TCP (伝送制御プロトコル) および UDP (ユーザー データグラム プロトコル) のインバウンドまたはアウトバウンドの接続のいずれかに使用できます。 パブリック IP アドレスがフロントエンド IP としてロード バランサーに追加されると、64,000 個のポートが SNAT として使用できるようになります。

負荷分散またはインバウンド NAT 規則に使用されるポートとして、64,000 個のポートのうち 8 つのポートが使用されます。 この使用により、SNAT で使用できるポートの数が減少します。 負荷分散またはインバウンド NAT 規則が、別のものと同じ 8 個の範囲内にある場合は、追加のポートは使用されません。 

### <a name="how-does-default-snat-work"></a>既定の SNAT の動作

VM がアウトバウンド フローを作成すると、Azure によって送信元 IP アドレスが一時 IP アドレスに変換されます。 この変換は [SNAT](#snat) を介して行われます。 

負荷分散規則で SNAT を使用している場合は、[既定の SNAT ポート割り当てテーブル](#snatporttable)に記載されているように、SNAT ポートが事前に割り当てられます。
 
標準の内部ロード バランサーを使用する場合、SNAT のために一時 IP アドレスは使用されません。 この機能は、既定でセキュリティをサポートします。 この機能により、リソースによって使用されるすべての IP アドレスが構成可能になり、予約できるようになります。 

標準の内部ロード バランサーを使用するときに、インターネットへのアウトバウンド接続を実現するには、次を構成します。

- インスタンス レベルのパブリック IP アドレス 
- NAT Gateway
- アウトバウンド規則が構成された標準のパブリック ロード バランサーへのバックエンド インスタンスの追加。  

### <a name="what-is-the-ip-for-default-snat"></a>既定の SNAT の IP は何ですか
VM がアウトバウンド フローを作成すると、Azure が、送信元 IP アドレスを、動的に割り当てられたパブリック送信元 IP アドレスに変換します。 このパブリック IP アドレスは **構成することができず**、予約することもできません。 このアドレスは、サブスクリプションのパブリック IP リソースの制限に対してカウントされません。 

次のものを再デプロイすると、パブリック IP アドレスは解放され、新しいパブリック IP が要求されます。 

 * 仮想マシン
 * 可用性セット
 * 仮想マシン スケール セット 

>[!NOTE]
> この方法は、ポートの枯渇リスクを高めるため、運用環境のワークロードには **推奨されません**。 接続エラーの可能性を避けるために、運用ワークロードにこの方法を使用しないようにしてください。 

| 種類 | アウトバウンド動作 | 
| ------------ | ------ | 
| Standard パブリック ロード バランサー | SNAT 用のロード バランサー フロントエンド IP の使用 |
| Standard 内部ロード バランサー | インターネット接続なし、既定でセキュリティ保護 | 
| Basic パブリック ロード バランサー | SNAT 用のロード バランサー フロントエンド IP の使用 |
| Basic 内部ロード バランサー | 不明な動的 IP アドレスを使用する SNAT |

## <a name="exhausting-ports"></a> ポートの枯渇

同じ宛先 IP および宛先ポートへのすべての接続には 1 つの SNAT ポートが使用されます。 この接続を使用して、バックエンド インスタンスまたは **クライアント** から **サーバー** に対する個別の **トラフィック フロー** が維持されます。 このプロセスにより、トラフィックを処理できる個別のポートがサーバーに提供されます。 このプロセスがないと、クライアント コンピューターでは、パケットがどのフローに属するかが認識されません。

複数のブラウザーを使用して、次のような https://www.microsoft.com にアクセスする場合について考えてみましょう。

* 宛先 IP = 23.53.254.142
* 宛先ポート = 443
* プロトコル = TCP

リターン トラフィック用の異なる宛先ポート (接続の確立に使用される SNAT ポート) がないと、クライアントでは 1 つのクエリ結果を別のクエリ結果と区別できません。

送信接続はバーストする可能性があります。 バックエンド インスタンスに不十分な数のポートが割り当てられる可能性があります。 **接続の再使用** が有効になっていないと、SNAT **ポートの枯渇** が発生するリスクが高まります。

ポートの枯渇が発生すると、宛先 IP への新しい送信接続は失敗します。 ポートが使用可能になると、接続は成功します。 この枯渇は、IP アドレスからの 64,000 個のポートが多数のバックエンド インスタンスにわたってまばらに分散されている場合に発生します。 SNAT ポートの枯渇を軽減するためのガイダンスについては、[トラブルシューティング ガイド](./troubleshoot-outbound-connection.md)のページを参照してください。  

TCP 接続の場合、ロード バランサーにはすべての宛先 IP とポートに 1 つの SNAT ポートが使用されます。 この複数使用により、同じ SNAT ポートを使用した同じ宛先 IP への複数の接続が可能になります。 接続が別の宛先ポートに接続されていない場合、この複数使用は制限されます。

UDP 接続の場合、ロード バランサーには **ポート制限コーン NAT** アルゴリズムが使用されます。この場合、宛先ポートに関係なく、宛先 IP ごとに 1 つの SNAT ポートが使用されます。 

無制限の接続数に対して 1 つのポートが再利用されます。 ポートは、宛先 IP またはポートが異なる場合にのみ再利用されます。

## <a name="default-port-allocation"></a><a name="preallocatedports"></a> 既定のポート割り当て

ロード バランサーのフロントエンド IP として割り当てられた各パブリック IP には、バックエンド プール メンバー用に 64,000 個の SNAT ポートが割り当てられています。 ポートをバックエンド プール メンバーと共有することはできません。 リターン パケットが正しくルーティングされるようにするために、SNAT ポートの範囲は 1 つのバックエンド インスタンスでのみ使用できます。 

負荷分散規則を介したアウトバウンド SNAT の自動割り当てを使用する場合、割り当てテーブルによって、IP ごとにポートの割り当てが定義されます。

<a name="snatporttable"></a>次の表は、バックエンド プール サイズのレベルに対する SNAT ポートの事前割り当てを示しています。

| プール サイズ (VM インスタンス) | IP 構成あたりの既定の SNAT ポート |
| --- | --- |
| 1-50 | 1,024 |
| 51-100 | 512 |
| 101-200 | 256 |
| 201-400 | 128 |
| 401-800 | 64 |
| 801-1,000 | 32 | 

## <a name="manual-port-allocation"></a><a name="preallocatedports"></a> ポートの手動割り当て

バックエンド プールのサイズと frontendIPConfigurations の数に基づいて SNAT ポートを手動で割り当てると、SNAT のポート不足を回避するのに役立ちます。 

"インスタンスあたりのポート数" または "バックエンド インスタンスの最大数" を使用して SNAT ポートを手動で割り当てできます。 バックエンドに仮想マシンがある場合は、SNAT ポートを最大限に使用できるように、"インスタンスあたりのポート数"を使用してポートを割り当てることをお勧めします。 インスタンスあたりのポート数は、次のように計算する必要があります。フロントエンド IP の数 * 64K / バックエンド インスタンスの数 フロントエンド IP の数 * 64K / いいえ。 。 それ以外の場合、バックエンドに仮想マシン スケール セットがある場合は、"バックエンド インスタンスの最大数" を使用してポートを割り当てることをお勧めします。 

ただし、許可されている残りの SNAT ポートよりも多くの VM がバックエンドに追加されると、VMSS のスケールアップがブロックされるか、新しい VM が十分な SNAT ポート数を取得できなくなるおそれがあります。 

## <a name="constraints"></a>制約

*   新しいパケットが送信されず、接続がアイドル状態の場合、ポートは 4 から 120 分後に解放されます。
  * このしきい値は、アウトバウンド規則を使用して構成できます。
*   各 IP アドレスには、SNAT に使用できる 64,000 個のポートが用意されています。
*   各ポートは、宛先 IP アドレスへの TCP 接続と UDP 接続の両方に使用できます
  * 宛先ポートが一意であるかどうかに関係なく、UDP SNAT ポートが必要です。 宛先 IP への UDP 接続ごとに、1 つの UDP SNAT ポートが使用されます。
  * 宛先ポートが異なる場合、1 つの TCP SNAT ポートを同じ宛先 IP への複数の接続に使用できます。
*   SNAT の枯渇は、バックエンド インスタンスが特定の SNAT ポートによって使い果たされたときに発生します。 この場合も、ロード バランサーには未使用の SNAT ポートを使用することができます。 バックエンド インスタンスに使用されている SNAT ポート数が指定された SNAT ポート数を超えると、新しい送信接続を確立できなくなります。
*   VM の NIC 上のインスタンス レベルのパブリック IP を経由して送信が行われない限り、断片化されたパケットは破棄されます。

## <a name="next-steps"></a>次のステップ

*   [SNAT の枯渇による送信接続エラーのトラブルシューティング](./troubleshoot-outbound-connection.md)
*   [SNAT メトリックを確認](./load-balancer-standard-diagnostics.md#how-do-i-check-my-snat-port-usage-and-allocation)し、それらをフィルター処理、分割、および表示する正しい方法を理解します。