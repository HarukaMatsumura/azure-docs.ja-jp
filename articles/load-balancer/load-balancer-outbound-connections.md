---
title: 送信プロキシの Azure Load Balancer
description: Azure Load Balancer を送信インターネット接続のプロキシとして使用する方法について説明します
services: load-balancer
author: asudbring
ms.service: load-balancer
ms.topic: conceptual
ms.custom: contperfq1
ms.date: 10/13/2020
ms.author: allensu
ms.openlocfilehash: 422f8106ac52c85f0680d54e420d0f1b4d326910
ms.sourcegitcommit: 2c586a0fbec6968205f3dc2af20e89e01f1b74b5
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/14/2020
ms.locfileid: "92017694"
---
# <a name="outbound-proxy-azure-load-balancer"></a>送信プロキシの Azure Load Balancer

Azure Load Balancer は、送信インターネット接続のプロキシとして使用できます。 このロード バランサーを使用すると、バックエンド インスタンスに送信接続が提供されます。 

この構成では、**ソース ネットワーク アドレス変換 (SNAT)** を使用します。 SNAT を使用して、バックエンドの IP アドレスをロード バランサーのパブリック IP アドレスに書き換えます。 

SNAT を使用すると、バックエンド インスタンスの **IP マスカレード**が可能になります。 このマスカレードによって、外部ソースはバックエンド インスタンスへの直接アドレスを取得できなくなります。 

バックエンド インスタンス間で 1 つの IP アドレスを共有すると、静的パブリック IP のコストが削減され、既知のパブリック IP からのトラフィックを含む IP 許可リストを簡略化するなどのシナリオがサポートされます。 

## <a name="sharing-ports-across-resources"></a><a name ="snat"></a> リソース間でのポートの共有

ロード バランサーのバックエンド リソースにインスタンスレベルのパブリック IP (ILPIP) アドレスがない場合、パブリック ロード バランサーのフロントエンド IP を介して送信接続が確立されます。

ポートは、個別のフローを維持するために使用される一意の識別子を生成するために使用されます。 インターネットには、この区別を実現するために 5 タプルが使用されます。

5 タプルの構成は次のとおりです。

* 宛先 IP
* 宛先ポート
* 発信元 IP
* この区別を実現するための送信元ポートとプロトコル。

受信接続にポートを使用する場合、そのポートでの受信接続要求には**リスナー**が使用されます。これは送信接続には使用できません。 

送信接続を確立するには、**エフェメラル ポート**を使用して、通信と個別のトラフィック フローの維持に使用するポートを宛先に提供する必要があります。 

各 IP アドレスには 65,535 個のポートがあります。 先頭の 1,024 個のポートは、**システム ポート**として予約されています。 各ポートは、TCP および UDP の受信接続または送信接続に使用できます。 

残りのポートのうち、Azure では、64,000 個を**エフェメラル ポート**として使用できます。 フロントエンド IP 構成として IP アドレスが追加されるときに、これらのエフェメラル ポートを SNAT に使用できます。

アウトバウンド規則を使用すると、これらの SNAT ポートをバックエンド インスタンスに分散し、送信接続用のロード バランサーのパブリック IP を共有できるようになります。

各バックエンド インスタンスのホスト上のネットワークによって、送信接続の一部であるパケットに対して SNAT が実行されます。 ホストによってソース IP はパブリック IP の 1 つに書き換えられます。 ホストによって、各送信パケットの送信元ポートは SNAT ポートの 1 つに書き換えられます。

## <a name="exhausting-ports"></a><a name="scenarios"></a> ポートの枯渇

同じ宛先 IP および宛先ポートへのすべての接続には 1 つの SNAT ポートが使用されます。 この接続を使用して、バックエンド インスタンスまたは**クライアント**から**サーバー**に対する個別の**トラフィック フロー**が維持されます。 このプロセスにより、トラフィックを処理できる個別のポートがサーバーに提供されます。 このプロセスがないと、クライアント コンピューターでは、パケットがどのフローに属するかが認識されません。

複数のブラウザーを使用して、次のような https://www.microsoft.com にアクセスする場合について考えてみましょう。

* 宛先 IP = 23.53.254.142
* 宛先ポート = 443
* プロトコル = TCP

リターン トラフィック用の異なる宛先ポート (接続の確立に使用される SNAT ポート) がないと、クライアントでは 1 つのクエリ結果を別のクエリ結果と区別できません。

送信接続はバーストする可能性があります。 バックエンド インスタンスに不十分な数のポートが割り当てられる可能性があります。 **接続の再使用**が有効になっていないと、SNAT **ポートの枯渇**が発生するリスクが高まります。

ポートの枯渇が発生すると、宛先 IP への新しい送信接続は失敗します。 ポートが使用可能になると、接続は成功します。 この枯渇は、IP アドレスからの 64,000 個のポートが多数のバックエンド インスタンスにわたってまばらに分散されている場合に発生します。 SNAT ポートの枯渇を軽減するためのガイダンスについては、[トラブルシューティング ガイド](https://docs.microsoft.com/azure/load-balancer/troubleshoot-outbound-connection)のページを参照してください。  

TCP 接続の場合、ロード バランサーにはすべての宛先 IP とポートに 1 つの SNAT ポートが使用されます。 この複数使用により、同じ SNAT ポートを使用した同じ宛先 IP への複数の接続が可能になります。 接続が別の宛先ポートに接続されていない場合、この複数使用は制限されます。

UDP 接続の場合、ロード バランサーには**ポート制限コーン NAT** アルゴリズムが使用されます。この場合、宛先ポートに関係なく、宛先 IP ごとに 1 つの SNAT ポートが使用されます。 

無制限の接続数に対して 1 つのポートが再利用されます。 ポートは、宛先 IP またはポートが異なる場合にのみ再利用されます。

## <a name="port-allocation"></a><a name="preallocatedports"></a> ポートの割り当て

ロード バランサーのフロントエンド IP として割り当てられた各パブリック IP には、バックエンド プール メンバー用に 64,000 個の SNAT ポートが割り当てられています。 ポートをバックエンド プール メンバーと共有することはできません。 リターン パケットが正しくルーティングされるようにするために、SNAT ポートの範囲は 1 つのバックエンド インスタンスでのみ使用できます。 

明示的なアウトバウンド規則を使用して SNAT ポートの割り当てを構成することをお勧めします。 この規則を使用して、各バックエンド インスタンスが送信接続に使用できる SNAT ポート数を最大限にします。 

負荷分散規則を介した送信 SNAT の自動割り当てを使用する場合、割り当てテーブルによってポートの割り当てが定義されます。

<a name="snatporttable"></a>次の表は、バックエンド プール サイズのレベルに対する SNAT ポートの事前割り当てを示しています。

| プール サイズ (VM インスタンス) | IP 構成あたりの事前に割り当てられる SNAT ポート |
| --- | --- |
| 1-50 | 1,024 |
| 51-100 | 512 |
| 101-200 | 256 |
| 201-400 | 128 |
| 401-800 | 64 |
| 801-1,000 | 32 | 

>[!NOTE]
> 最大サイズが 6 のバックエンド プールがある場合、明示的なアウトバウンド規則を定義すると、各インスタンスには 64,000/10 = 6,400 個のポートを割り当てることができます。 上の表によると、自動割り当てを選択した場合、それぞれに 1,024 個しかありません。

## <a name="outbound-rules-and-virtual-network-nat"></a><a name="outboundrules"></a> アウトバウンド規則と Virtual Network NAT

Azure Load Balancer のアウトバウンド規則と Virtual Network NAT は、仮想ネットワークからのエグレスに使用できるオプションです。

アウトバウンド規則の詳細については、[アウトバウンド規則](outbound-rules.md)に関するページを参照してください。

Azure Virtual Network NAT の詳細については、「[Azure Virtual Network NAT とは](../virtual-network/nat-overview.md)」を参照してください。

## <a name="constraints"></a>制約

*   **TCP RST** が受信または送信された場合、ポートは 15 秒後に解放されます
*   **FINACK** が受信または送信された場合、ポートは 240 秒後に解放されます
*   新しいパケットが送信されず、接続がアイドル状態の場合、ポートは 4 から 120 分後に解放されます。
  * このしきい値は、アウトバウンド規則を使用して構成できます。
*   各 IP アドレスには、SNAT に使用できる 64,000 個のポートが用意されています。
*   各ポートは、宛先 IP アドレスへの TCP 接続と UDP 接続の両方に使用できます
  * 宛先ポートが一意であるかどうかに関係なく、UDP SNAT ポートが必要です。 宛先 IP への UDP 接続ごとに、1 つの UDP SNAT ポートが使用されます。
  * 宛先ポートが異なる場合、1 つの TCP SNAT ポートを同じ宛先 IP への複数の接続に使用できます。
*   SNAT の枯渇は、バックエンド インスタンスが特定の SNAT ポートによって使い果たされたときに発生します。 この場合も、ロード バランサーには未使用の SNAT ポートを使用することができます。 バックエンド インスタンスに使用されている SNAT ポート数が指定された SNAT ポート数を超えると、新しい送信接続を確立できなくなります。

## <a name="next-steps"></a>次のステップ

*   [SNAT の枯渇による送信接続エラーのトラブルシューティング](https://docs.microsoft.com/azure/load-balancer/troubleshoot-outbound-connection)
*   [SNAT メトリックを確認](https://docs.microsoft.com/azure/load-balancer/load-balancer-standard-diagnostics#how-do-i-check-my-snat-port-usage-and-allocation)し、それらをフィルター処理、分割、および表示する正しい方法を理解します。

