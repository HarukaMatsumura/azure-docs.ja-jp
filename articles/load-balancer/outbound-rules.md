---
title: Azure Load Balancer のアウトバウンド規則
description: この記事では、Azure Load Balancer を使用したインターネット トラフィックのエグレスを制御するアウトバウンド規則を構成する方法について説明します。
services: load-balancer
author: asudbring
ms.service: load-balancer
ms.topic: conceptual
ms.custom: contperfq1
ms.date: 10/13/2020
ms.author: allensu
ms.openlocfilehash: 51810876e3636b7023ce9c9318a071636bb00c4c
ms.sourcegitcommit: 090ea6e8811663941827d1104b4593e29774fa19
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/13/2020
ms.locfileid: "92002613"
---
# <a name="outbound-rules-azure-load-balancer"></a><a name="outboundrules"></a>Azure Load Balancer のアウトバウンド規則

アウトバウンド規則を使用すると、パブリック標準ロード バランサーの送信 SNAT (送信元ネットワーク アドレス変換) を構成できます。 この構成では、ロード バランサーのパブリック IP をプロキシとして使用できます。

この構成を使用すると、以下が可能になります。

* IP マスカレード
* 許可リストの単純化。
* デプロイするパブリック IP リソース数の削減。

アウトバウンド規則を使用すると、送信インターネット接続を完全に宣言的に制御できます。 アウトバウンド規則を使用すると、特定のニーズに合わせてこの機能をスケーリングおよび調整することができます。 

アウトバウンド規則は、バックエンド VM にインスタンスレベルのパブリック IP アドレス (ILPIP) がない場合にのみ適用されます。

![Load Balancer のアウトバウンド規則](media/load-balancer-outbound-rules-overview/load-balancer-outbound-rules.png)

アウトバウンド規則を使用して、送信 **SNAT** の動作を明示的に定義できます。

アウトバウンド規則によって以下を制御できます。

* **どの仮想マシンがどのパブリック IP アドレスに変換されるか。**
     * 2 つの規則により、バックエンド プール A によって IP アドレス A と B が使用され、バックエンド プール B によって IP アドレス C と D が使用されます。
* **送信 SNAT ポートを指定する方法。**
     * バックエンド プール B は送信接続を行う唯一のプールであり、バックエンド プール B にすべての SNAT ポートを提供し、バックエンド プール A には何も提供しません。
* **アウトバウンド変換の提供対象となるプロトコル。**
     * バックエンド プール B には、送信用の UDP ポートが必要です。 バックエンド プール A には TCP が必要です。 TCP ポートを A に、UDP ポートを B に提供します。
* **アウトバウンド接続のアイドル タイムアウトの時間 (4 分から 120 分)。**
     * キープアライブを使用した長期の接続がある場合は、長期の接続用にアイドル ポートを最大 120 分間予約します。 古い接続が破棄され、新しい接続用にポートが 4 分以内に解放されることを想定します 
* **アイドル タイムアウト時に TCP リセットを送信するかどうか。**
     * アイドル状態の接続がタイムアウトになった場合は、フローが破棄されていることがわかるように TCP RST をクライアントとサーバーに送信しますか?

## <a name="outbound-rule-definition"></a>アウトバウンド規則の定義

アウトバウンド規則は、負荷分散およびインバウンド NAT 規則と同じ使い慣れた構文 (**フロントエンド** + **パラメーター** + **バックエンド プール**) に従います。 

アウトバウンド規則では、"_フロントエンド_" に変換される、"_バックエンド プールによって識別されるすべての仮想マシン_" のアウトバウンド NAT を構成します。  

"_パラメーター_" により、アウトバウンド NAT アルゴリズムをさらに細かく制御できます。

## <a name="scale-outbound-nat-with-multiple-ip-addresses"></a><a name="scale"></a>複数の IP アドレスでアウトバウンド NAT をスケーリングする

フロントエンドによって提供される追加の IP アドレスごとに、ロード バランサーによって SNAT ポートとして使用される 64,000 個の一時的なポートが追加されます。 

複数の IP アドレスを使用して大規模なシナリオを計画します。 アウトバウンド規則を使用して [SNAT の不足](troubleshoot-outbound-connection.md#snatexhaust)を軽減します。 

[パブリック IP プレフィックス](https://aka.ms/lbpublicipprefix)をアウトバウンド規則で直接使用することもできます。 

パブリック IP プレフィックスを使用すると、デプロイのスケーリングが向上します。 プレフィックスは、Azure リソースから送信されたフローの許可リストに追加できます。 パブリック IP アドレス プレフィックスを参照するように、ロード バランサー内のフロントエンド IP 構成を設定できます。  

ロード バランサーにより、パブリック IP プレフィックスが制御されます。 アウトバウンド規則により、パブリック IP プレフィックスに含まれるすべてのパブリック IP アドレスが自動的にアウトバウンド接続に使用されるようになります。 

パブリック IP プレフィックスの内の IP アドレスごとに、ロード バランサーが SNAT ポートとして使用する 64,000 個の一時的なポートが追加されます。

## <a name="outbound-flow-idle-timeout-and-tcp-reset"></a><a name="idletimeout"></a> アウトバウンド フローのアイドル タイムアウトと TCP リセット

アウトバウンド規則には、アウトバウンド フローのアイドル タイムアウトを制御し、アプリケーションのニーズに合わせるための構成パラメーターがあります。 アウトバウンド アイドル タイムアウトの既定値は 4 分です。 詳細については、[アイドル タイムアウトの構成](load-balancer-tcp-idle-timeout.md)に関する記事を参照してください。 

ロード バランサーの既定の動作では、アウトバウンド アイドル タイムアウトに達すると、警告なしにフローが破棄されます。 `enableTCPReset` パラメーターを使用すると、予測可能なアプリケーションの動作と制御が可能になります。 このパラメーターを使用して、送信アイドル タイムアウトのタイムアウト時に双方向 TCP リセット (TCP RST) を送信するかどうかを指定します。 

利用可能なリージョンなど、詳細については、[アイドル タイムアウト時の TCP リセット](https://aka.ms/lbtcpreset)に関するページをご覧ください。

## <a name="securing-and-controlling-outbound-connectivity-explicitly"></a><a name="preventoutbound"></a>送信接続を明示的に保護および制御する

負荷分散規則により、アウトバウンド NAT の自動プログラミングが提供されます。 負荷分散規則によるアウトバウンド NAT の自動プログラミングを無効にすることでメリットが得られる、またはこれが必要なシナリオもあります。 規則を介して無効にすると、動作を制御または調整できるようになります。  

このパラメーターには、次の 2 通りの使い方があります。

1. アウトバウンド SNAT のインバウンド IP アドレスの防止。 負荷分散規則でアウトバウンド SNAT を無効にします。
  
2. インバウンドとアウトバウンドに同時に使用される IP アドレスのアウトバウンド **SNAT** パラメーターを調整します。 アウトバウンド規則による制御を可能にするには、自動のアウトバウンド NAT を無効にする必要があります。 インバウンドにも使用されるアドレスの SNAT ポートの割り当てを変更するには、`disableOutboundSnat` パラメーターを true に設定する必要があります。 

インバウンドに使用する IP アドレスを再定義しようとすると、アウトバウンド規則を構成する操作は失敗します。  まず、負荷分散規則のアウトバウンド NAT を無効にします。

>[!IMPORTANT]
> このパラメーターを true に設定し、アウトバウンド接続を定義するアウトバウンド規則がない場合、仮想マシンはアウトバウンド接続できなくなります。  VM またはアプリケーションの一部の操作は、アウトバウンド接続が使用可能であることに依存している場合があります。 使用しているシナリオの依存関係を理解し、この変更による影響を考慮してください。

場合によっては、VM でアウトバウンド フローを作成するのは望ましくない場合があります。 アウトバウンド フローを受信する宛先やインバウンド フローを開始する宛先を管理するための要件がある場合もあります。 [ネットワーク セキュリティ グループ](../virtual-network/security-overview.md)を使用して、VM が接続できる宛先を管理します。 NSG を使用して、インバウンド フローを開始するパブリックの宛先を管理します。

負荷分散された VM に NSG を適用するときは、[サービス タグ](../virtual-network/security-overview.md#service-tags)と[既定のセキュリティ規則](../virtual-network/security-overview.md#default-security-rules)に注意してください。 

VM が Azure Load Balancer からの正常性プローブ要求を受け取ることができるようにしておいてください。

NSG が AZURE_LOADBALANCER 既定タグからの正常性プローブ要求をブロックすると、VM の正常性プローブが失敗して VM が利用不可とマークされます。 ロード バランサーにより、その VM への新しいフローの送信が停止されます。

## <a name="limitations"></a>制限事項

- フロントエンド IP アドレスごとに使用可能なエフェメラル ポートの最大数は 64,000 個です。
- 構成可能なアウトバウンド アイドル タイムアウトの範囲は、4 から 120 分 (240 から 7200 秒) です。
- ロード バランサーでは、アウトバウンド NAT の ICMP はサポートされていません。
- アウトバウンド規則は、NIC のプライマリ IP 構成にのみ適用できます。  VM または NVA のセカンダリ IP のアウトバウンド規則を作成することはできません。 複数 NIC がサポートされています。
- **可用性セット**内のすべての仮想マシンを、アウトバウンド接続のバックエンド プールに追加する必要があります。 
- **仮想マシン スケール セット**内のすべての仮想マシンを、アウトバウンド接続のバックエンド プールに追加する必要があります。

## <a name="next-steps"></a>次の手順

- [Azure Standard Load Balancer](load-balancer-overview.md) について理解を深める
- [Azure Load Balancer についてよく寄せられる質問](load-balancer-faqs.md)を確認する

