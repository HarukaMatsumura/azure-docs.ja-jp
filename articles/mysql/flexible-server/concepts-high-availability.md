---
title: Azure Database for MySQL フレキシブル サーバーでのゾーン冗長による高可用性の概念
description: Azure Database for MySQL - フレキシブル サーバーでのゾーン冗長による高可用性の概念について説明します
author: savjani
ms.author: pariks
ms.service: mysql
ms.topic: conceptual
ms.date: 08/10/2021
ms.openlocfilehash: d78bb5aeb111411641508b38bd49a6f5bcbf5374
ms.sourcegitcommit: 2d412ea97cad0a2f66c434794429ea80da9d65aa
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/14/2021
ms.locfileid: "122177850"
---
# <a name="high-availability-concepts-in-azure-database-for-mysql-flexible-server-preview"></a>Azure Database for MySQL フレキシブル サーバー (プレビュー) での高可用性の概念

[!INCLUDE[applies-to-mysql-flexible-server](../includes/applies-to-mysql-flexible-server.md)]

> [!IMPORTANT] 
> Azure Database for MySQL - フレキシブル サーバーは現在、パブリック プレビュー段階にあります。

Azure Database for MySQL フレキシブル サーバー (プレビュー) では、自動フェールオーバーによる高可用性を構成できます。 高可用性が構成されている場合、フレキシブル サーバーでは、2 つの異なるオプションを使用してスタンバイ レプリカを自動的にプロビジョニングおよび管理します

* **ゾーン冗長の高可用性**: このオプションは、複数の可用性ゾーンにわたるインフラストラクチャの完全な分離と冗長性を実現する場合に適しています。 最高レベルの可用性が提供されますが、ゾーン間でアプリケーションの冗長性を構成する必要があります。 ゾーン冗長 HA は、可用性ゾーン内のインフラストラクチャ障害に対して最高レベルの可用性を実現する必要があり、可用性ゾーン全体の待機時間を許容できる場合に推奨されます。 ゾーン冗長 HA は、リージョンが複数の可用性ゾーンをサポートし、ゾーン冗長 HA が使用可能な [Azure リージョンのサブセット](https://docs.microsoft.com/azure/mysql/flexible-server/overview#azure-regions)で使用できます。

* **同一ゾーンの高可用性**: このオプションは、プライマリ サーバーとスタンバイ サーバーの両方が同じ可用性ゾーンに含まれ、ネットワーク待機時間が短いインフラストラクチャの冗長性に適しています。 ゾーン間でアプリケーションの冗長性を構成せずに高可用性を実現します。 単一の可用性ゾーン内で、ネットワーク待機時間が最も短い最高レベルの可用性を実現する必要がある場合は、同一ゾーン HA が推奨されます。 同一ゾーン HA は、[フレキシブル サーバーを使用できるすべての Azure リージョン](https://docs.microsoft.com/azure/mysql/flexible-server/overview#azure-regions)で使用できます。  

## <a name="zone-redundant-high-availability"></a>ゾーン冗長の高可用性

ゾーン冗長の高可用性を有効にしたフレキシブル サーバーが作成されると、データ ファイルとログ ファイルは[ゾーン冗長ストレージ (ZRS)](../../storage/common/storage-redundancy.md#redundancy-in-the-primary-region) でホストされます。 ZRS で使用できるストレージ レベルのレプリケーションを使用すると、データ ファイルとログ ファイルがスタンバイ サーバーに同期的にレプリケートされ、データ損失がゼロになります。 フェールオーバーは、クライアント アプリケーションから完全に透過的で、ユーザーによる操作は必要ありません。 フェールオーバー中にオンラインになるスタンバイ サーバーの回復は、スタンバイ上のバイナリ ログ アプリケーションによって異なります。 そのため、フェールオーバー時間を短縮するには、すべてのテーブルで主キーを使用することをお勧めします。 スタンバイ サーバーは、読み取りまたは書き込み操作に使用できるものではなく、高速フェールオーバーを可能にするためのパッシブ スタンバイです。 フェールオーバー時間の範囲は、通常、60 秒から 120 秒までです。

> [!Note]
> ゾーン冗長 HA では、ネットワーク待機時間がおよそ 2 ～ 4 ミリ秒と比較的長い可用性ゾーン間でデータベース サーバーに接続しているアプリケーションの場合、待機時間が 5 ～ 10% 低下する可能性があります。 

:::image type="content" source="./media/concepts-high-availability/1-flexible-server-overview-zone-redundant-ha.png" alt-text="ゾーン冗長 HA":::

### <a name="zone-redundancy-architecture"></a>ゾーン冗長アーキテクチャ

プライマリ サーバーは、リージョンと特定の可用性ゾーンにデプロイされます。 高可用性を選択すると、コンピューティング レベル、コンピューティング サイズ、ストレージ サイズ、ネットワーク構成など、プライマリ サーバーと同じ構成のスタンバイ レプリカ サーバーが、"指定された可用性ゾーン" に自動的にデプロイされます。 ログ データは、スタンバイ レプリカに同期的にレプリケートされ、どのような障害状況でもデータ損失がゼロになることが保証されます。 自動バックアップ、両方のスナップショット、ログ バックアップは、ゾーン冗長ストレージ上でプライマリ データベース サーバーから実行されます。

### <a name="standby-zone-selection"></a>スタンバイ ゾーンの選択
ゾーン冗長の高可用性シナリオでは、任意のスタンバイ サーバー ゾーンの場所を選択できます。 スタンバイ データベース サーバーとスタンバイ アプリケーションを同じゾーンに配置すると、待機時間が短縮され、ユーザーはディザスター リカバリーの状況や "ゾーンダウン" シナリオに対してより適切に準備できます。

## <a name="same-zone-high-availability"></a>同一ゾーンの高可用性

同一ゾーンの高可用性を有効にしたフレキシブル サーバーが作成されると、データ ファイルとログ ファイルは[ローカル冗長ストレージ (LRS)](https://docs.microsoft.com/azure/storage/common/storage-redundancy#locally-redundant-storage) でホストされます。 LRS で使用できるストレージ レベルのレプリケーションを使用すると、データ ファイルとログ ファイルがスタンバイ サーバーに同期的にレプリケートされ、データ損失がゼロになります。 スタンバイ サーバーでは、独立した仮想マシン (コンピューティング) を使用してインフラストラクチャの冗長性を提供します。これによって、ユーザー アプリケーションとデータベース サーバーの間のコロケーションに起因するフェールオーバー時間とネットワーク待機時間が短縮されます。 フェールオーバーは、クライアント アプリケーションから完全に透過的で、ユーザーによる操作は必要ありません。 フェールオーバー中にオンラインになるスタンバイ サーバーの回復は、スタンバイ上のバイナリ ログ アプリケーションによって異なります。 そのため、フェールオーバー時間を短縮するには、すべてのテーブルで主キーを使用することをお勧めします。 スタンバイ サーバーは、読み取りまたは書き込み操作に使用できるものではなく、高速フェールオーバーを可能にするためのパッシブ スタンバイです。 フェールオーバー時間の範囲は、通常、60 秒から 120 秒までです。

同一ゾーンの高可用性を使用すると、ユーザーはプライマリ サーバーと同じゾーンにスタンバイ サーバーを配置できます。そのため、プライマリとスタンバイの間のレプリケーションの遅延が軽減されます。 また、同じ Azure 可用性ゾーン内に配置されている場合、アプリケーション サーバーとデータベース サーバーの間の待機時間も短くなります。

:::image type="content" source="./media/concepts-high-availability/flexible-server-overview-same-zone-ha.png" alt-text="同じ冗長高可用性":::

## <a name="high-availability-monitoring"></a>高可用性の監視
HA の正常性は、概要ページで継続的に監視され、報告されます。 さまざまなレプリケーションの状態を次に示します。

| **状態** | **説明** |
| :----- | :------ |
| <b>NotEnabled | ゾーン冗長による HA が有効ではありません |
| <b>ReplicatingData | スタンバイの作成後、そのスタンバイがプライマリ サーバーにキャッチアップ中です。 |
| <b>FailingOver | データベース サーバーは、プライマリからスタンバイにフェールオーバー中です。 |
| <b>Healthy | ゾーン冗長による HA は、安定した状態で正常です。 |
| <b>RemovingStandby | ユーザーの操作に基づいて、スタンバイ レプリカを削除中です。| 

## <a name="advantages"></a>長所

ゾーン冗長による HA 機能を使用する場合、次のような利点があります。 

- スタンバイ レプリカでは、仮想コア、ストレージ、ネットワーク設定 (VNET、ファイアウォール) など、プライマリとまったく同じ VM 構成でデプロイが行われます。
- 高可用性を無効にすることによってスタンバイ レプリカを削除できます。
- 自動バックアップはスナップショット ベースであり、プライマリ データベース サーバーから実行され、高可用性オプションに応じてゾーン冗長ストレージまたはローカル冗長ストレージに格納されます。
- フェールオーバー時には、高可用性が有効になっていれば、Azure Database for MySQL フレキシブル サーバーが自動的にスタンバイ レプリカにフェールオーバーされます。 高可用性の設定では、プライマリ サーバーが監視され、オンラインに戻されます。
- クライアントは常に、プライマリ データベース サーバーに接続されます。
- データベースのクラッシュやノードの障害が発生すると、同じノードでフレキシブル サーバー VM が再起動します。 同時に、自動フェールオーバーがトリガーされます。 フェールオーバーが完了する前にフレキシブル サーバー VM の再起動が成功した場合、フェールオーバー操作は取り消されます。
- サーバーを再起動して静的サーバー パラメーターの変更を取得できます。

## <a name="steady-state-operations"></a>安定状態の操作

アプリケーションは、データベース サーバー名を使用してプライマリ サーバーに接続されます。 スタンバイ レプリカの情報は、直接アクセスに対して公開されません。 コミットと書き込みは、プライマリ サーバーのゾーン冗長ストレージ (ZRS) ストレージでログ ファイルをフラッシュした後に確認されます。 ZRS ストレージで使用される同期レプリケーション テクノロジにより、アプリケーションでは書き込みとコミットの待機時間が短くなる可能性があります。

## <a name="failover-process"></a>フェールオーバー プロセス 
ビジネス継続性を確保するには、計画イベントと予定外のイベントのためのフェールオーバー プロセスが必要です。 

>[!NOTE]
> 常に完全修飾ドメイン名 (FQDN) を使用してプライマリ サーバーに接続し、接続に IP アドレスを使用しないようにします。 フェールオーバーが発生した場合、プライマリおよびスタンバイ サーバーの役割が切り替えられると、DNS A レコードも変更される可能性があります。これにより、接続文字列で IP アドレスが使用されている場合に、アプリケーションが新しいプライマリ サーバーに接続できなくなる可能性があります。 

### <a name="planned-events---forced-failover"></a>計画イベント - 強制フェールオーバー

Azure Database for MySQL 強制フェールオーバーによって手動で強制的にフェールオーバーできるため、この機能をアプリケーション シナリオでテストして、障害が発生した場合に備えることができます。 強制フェールオーバーでトリガーされるフェールオーバーによりスタンバイ レプリカがアクティブになってプライマリ サーバーになることで、スタンバイ サーバーはプライマリ サーバーに切り替わります。このとき DNS レコードが更新されることで、同じデータベース サーバー名が使用されます。 最初のプライマリ サーバーは再起動して、スタンバイ レプリカに切り替わります。 クライアント接続は切断されて、操作を再開するためには再接続が必要になります。 現在のワークロードと最後のチェックポイントに応じて、全体的なフェールオーバーの時間が測定されます。 一般には、60 秒から 120 秒の範囲であると予想されます。 

### <a name="failover-process---unplanned-events"></a>フェールオーバー プロセス - 予定外のイベント
予定外のサービス ダウンタイムとしては、データベースの可用性に影響を与えるソフトウェアのバグや、コンピューティング、ネットワーク、ストレージ障害などのインフラストラクチャの障害、停電があります。 データベースが使用できなくなった場合、スタンバイ レプリカへのレプリケーションは停止され、スタンバイ レプリカがアクティブ化されてプライマリ データベースになります。 DNS が更新された後、クライアントはデータベース サーバーに再接続され、操作を開始します。 全体的なフェールオーバー時間は、60 から 120 秒になると予想されます。 ただし、フェールオーバーの時点でのプライマリ データベース サーバー内のアクティビティ (大規模なトランザクションや復旧時間など) によっては、フェールオーバーがこれより長くなる可能性があります。

## <a name="schedule-maintenance-window"></a>メンテナンス期間のスケジュール 

フレキシブル サーバーには、メンテナンス スケジュール機能が用意されています。この機能では、1 日のうちで、パッチやマイナー バージョン アップグレードなどの Azure メンテナンス作業が行われる 30 分間を任意で選択できます。 高可用性が構成されているフレキシブル サーバーの場合、これらのメンテナンス アクティビティは、最初にスタンバイ レプリカで実行されます。 

## <a name="point-in-time-restore"></a>ポイントインタイム リストア 
フレキシブル サーバーは高可用性で構成され、データが同期的にレプリケートされるため、スタンバイ サーバーはプライマリに合わせて最新の状態です。 プライマリ上のユーザー エラー (テーブルの誤った削除や不正な更新など) はすべて、スタンバイに忠実にレプリケートされます。 そのため、スタンバイを使用して、このような論理エラーから復旧することはできません。 これらの論理エラーから復旧するには、エラーが発生する直前の時点へのポイントインタイム リストアを実行する必要があります。 フレキシブル サーバーのポイントインタイム リストア機能を使用すると、高可用性で構成されたデータベースを復元するとき、新しいデータベース サーバーは、ユーザー指定の名前を持つ新しいフレキシブル サーバーとして復元されます。 その後、データベース サーバーからオブジェクトをエクスポートし、それを運用データベース サーバーにインポートできます。 同様に、テストや開発の目的でデータベース サーバーを複製する場合、または他の目的で復元する場合、最新の復元ポイントまたはカスタムの復元ポイントのいずれかを選択できます。 復元操作により、単一ゾーンのフレキシブル サーバーが作成されます。

## <a name="mitigate-downtime"></a>ダウンタイムを軽減する 
ゾーン冗長による HA 機能を使用しない場合でも、アプリケーションのダウンタイムを軽減できる必要があります。 スケジュールされたパッチ、マイナー バージョン アップグレード、ユーザーが開始した操作などのサービス ダウンタイムの計画は、スケジュールされたメンテナンス期間の一部として実行できます。 スケジュールされたパッチ、マイナー バージョン アップグレード、ユーザーが開始した操作 (コンピューティングのスケーリングなど) などの予定されたサービス ダウンタイムによって、ダウンタイムが発生します。 Azure によって開始されるメンテナンス タスクがアプリケーションに与える影響を軽減するために、アプリケーションに対する影響が最も少ない曜日と時刻にタスクをスケジュールすることを選択できます。 

データベースのクラッシュやサーバーの障害などの予定外のダウンタイム イベントが発生すると、影響を受けたサーバーが同じゾーン内で再起動されます。 まれですが、ゾーン全体が影響を受けた場合は、データベースをリージョン内の別のゾーンで復元することができます。 

## <a name="things-to-know-with-zone-redundancy"></a>ゾーン冗長に関する注意事項 

ゾーン冗長による高可用性を使用する場合、次の点に注意してください。 

- 高可用性は、フレキシブル サーバーの作成時に **のみ** 設定できます。
- 高可用性は、バースト可能なコンピューティング レベルではサポートされません。
- 別の可用性ゾーンへの同期レプリケーションのために、プライマリ データベース サーバーで書き込みとコミットの待機時間が長くなる場合があります。
- スタンバイ レプリカを読み取り専用クエリに使用することはできません。
- フェールオーバーの時点でのプライマリ サーバー上のアクティビティによっては、フェールオーバーが完了するまでに最大 60 から 120 秒かかることがあります。
- 静的パラメーターの変更を取得するためにプライマリ データベース サーバーを再起動すると、スタンバイ レプリカも再起動されます。
- ゾーン冗長による高可用性サーバーに対して読み取りレプリカを構成することはサポートされていません。
- 顧客が開始する管理タスクの構成を、管理されたメンテナンス期間中に自動化することはできません。
- コンピューティングのスケーリングやマイナー バージョン アップグレードなどの予定イベントは、プライマリとスタンバイの両方で同時に発生します。 


## <a name="next-steps"></a>次のステップ

- [ビジネス継続性](./concepts-business-continuity.md)について確認する
- [ゾーン冗長による高可用性](./concepts-high-availability.md)について確認する
- [バックアップと復旧](./concepts-backup-restore.md)について確認する