---
title: Azure Database for MySQL フレキシブル サーバーでのゾーン冗長による高可用性の概念
description: Azure Database for MySQL - フレキシブル サーバーでのゾーン冗長による高可用性の概念について説明します
author: SudheeshGH
ms.author: sunaray
ms.service: mysql
ms.topic: conceptual
ms.date: 08/26/2021
ms.openlocfilehash: 4a8f7d5bd10c21b14c8935bf0a44040501ebeb90
ms.sourcegitcommit: dcf1defb393104f8afc6b707fc748e0ff4c81830
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/27/2021
ms.locfileid: "123109190"
---
# <a name="high-availability-concepts-in-azure-database-for-mysql-flexible-server-preview"></a>Azure Database for MySQL フレキシブル サーバー (プレビュー) での高可用性の概念

[!INCLUDE[applies-to-mysql-flexible-server](../includes/applies-to-mysql-flexible-server.md)]

> [!IMPORTANT] 
> Azure Database for MySQL - フレキシブル サーバーは現在、パブリック プレビュー段階にあります。

Azure Database for MySQL フレキシブル サーバー (プレビュー) では、自動フェールオーバーによる高可用性を構成できます。 高可用性ソリューションは、コミットされたデータが障害によって失われないこと、データベースがソフトウェア アーキテクチャでの単一障害点にならないことを保証するように設計されています。 高可用性が構成されている場合、フレキシブル サーバーは、スタンバイ レプリカを自動的にプロビジョニングして管理します。 高可用性アーキテクチャ モデルには、次の 2 つがあります。

* **ゾーン冗長の高可用性 (HA)** : このオプションは、複数の可用性ゾーンにわたってインフラストラクチャの完全な分離と冗長性を実現する場合に適しています。 最高レベルの可用性が提供されますが、複数のゾーンにわたってアプリケーションの冗長性を構成しなければなりません。 ゾーン冗長 HA は、可用性ゾーン内のインフラストラクチャ障害に対して最高レベルの可用性を実現する必要があり、可用性ゾーン全体の待機時間を許容できる場合に推奨されます。 ゾーン冗長 HA は、サーバーの作成時にのみ有効にできます。 ゾーン冗長 HA は、リージョンが複数の[可用性ゾーン](../../availability-zones/az-overview.md)をサポートし、[ゾーン冗長 Premium ファイルシェア](../..//storage/common/storage-redundancy.md#zone-redundant-storage)が利用可能な場合に、利用できる [Azure リージョンのサブセット](./overview.md#azure-regions)です。

* **同一ゾーンの高可用性 (HA)** : このオプションは、プライマリ サーバーとスタンバイ サーバーの両方が同じ可用性ゾーンに含まれ、ネットワーク待機時間が短いインフラストラクチャの冗長性に適しています。 ゾーン間でアプリケーションの冗長性を構成せずに高可用性を実現します。 単一の可用性ゾーン内で、ネットワーク待機時間が最も短い最高レベルの可用性を実現する必要がある場合は、同一ゾーン HA が推奨されます。 同一ゾーン HA は、Azure Database for MySQL フレキシブル サーバーを作成できるすべての  [Azure リージョン](./overview.md#azure-regions)で使用できます。  

## <a name="zone-redundancy-high-availability-architecture"></a>ゾーン冗長の高可用性のアーキテクチャ
 
ゾーン冗長 HA オプションを使用してサーバーをデプロイすると、1 つの可用性ゾーンにプライマリ サーバーが作成され、同じ Azure リージョンの別の可用性ゾーンにプライマリ サーバー (コンピューティング階層、コンピューティング サイズ、ストレージ サイズ、ネットワーク構成) が同じ構成のスタンバイ レプリカ サーバーが作成されます。 プライマリ レプリカとスタンバイ レプリカに対して、選択した可用性ゾーンを指定できます。 スタンバイ データベース サーバーとスタンバイ アプリケーションを同じゾーンに配置すると、待機時間が短縮され、ユーザーはディザスター リカバリーの状況や「ゾーン ダウン」シナリオに対してより適切に準備できます。

:::image type="content" source="./media/concepts-high-availability/1-flexible-server-overview-zone-redundant-ha.png" alt-text="ゾーン冗長 HA":::

データ ファイルとログ ファイルは、[ゾーン冗長ストレージ (ZRS)](../../storage/common/storage-redundancy.md#redundancy-in-the-primary-region) でホストされます。 ZRS で利用可能なストレージ レベルのレプリケーションを使用して、データ ファイルとログ ファイルをスタンバイ サーバーにレプリケートします。 フェールオーバーがある場合は、スタンバイ レプリカが有効化され、プライマリ サーバーのバイナリ ログ ファイルがスタンバイ サーバーに引き続き適用され、プライマリで最後にコミットされたトランザクションにオンラインになります。 ZRS のログを使用すると、プライマリ サーバーが使用できない場合でもログにアクセスでき、データ損失がゼロになります。 スタンバイ レプリカがアクティブ化され、バイナリ ログが適用されると、現在のスタンバイ レプリカ サーバーがプライマリ サーバーの役割を担います。 DNS が更新され、クライアントの再接続時にクライアント接続が新しいプライマリに転送されます。 フェールオーバーは、クライアント アプリケーションから完全に透過的で、ユーザーによる操作は必要ありません。 その後、高可用性ソリューションは、可能であれば古いプライマリ サーバーを回復し、スタンバイとして配置します。
 
アプリケーションは、データベース サーバー名を使用してプライマリ サーバーに接続されます。 スタンバイ レプリカの情報は、直接アクセスに対して公開されません。 コミットと書き込みは、プライマリ サーバーのゾーン冗長ストレージ (ZRS) ストレージでログ ファイルをフラッシュした後に確認されます。 ZRS ストレージで使用される同期レプリケーション テクノロジにより、アプリケーションでは書き込みとコミットの待機時間が 5 % から 10 % 増加する可能性があります。
 
自動バックアップ、両方のスナップショット、ログ バックアップは、ゾーン冗長ストレージ上でプライマリ データベース サーバーから実行されます。

## <a name="same-zone-high-availability-architecture"></a>同じゾーンの高可用性アーキテクチャ
 
同じゾーンの HA オプションを使用してサーバーをデプロイすると、プライマリ サーバーとスタンバイ レプリカ サーバーが同じゾーンに作成され、プライマリ サーバーの構成が同じになります (コンピューティング階層、コンピューティング サイズ、ストレージ サイズ、ネットワーク構成)。 スタンバイ サーバーでは、独立した仮想マシン (コンピューティング) を使用してインフラストラクチャの冗長性を提供します。これによって、ユーザー アプリケーションとデータベース サーバーの間のコロケーションに起因するフェールオーバー時間とネットワーク待機時間が短縮されます。

:::image type="content" source="./media/concepts-high-availability/flexible-server-overview-same-zone-ha.png" alt-text="同じ冗長高可用性":::

データ ファイルとログ ファイルは、[ローカル冗長ストレージ (LRS)](../../storage/common/storage-redundancy.md#locally-redundant-storage) でホストされます。 LRS で利用可能なストレージ レベルのレプリケーションを使用して、データ ファイルとログ ファイルをスタンバイ サーバーにレプリケートします。

フェールオーバーがある場合は、スタンバイ レプリカが有効化され、プライマリ サーバーのバイナリ ログ ファイルがスタンバイ サーバーに引き続き適用され、プライマリで最後にコミットされたトランザクションにオンラインになります。 LRS のログを使用すると、プライマリ サーバーが使用できない場合でもログにアクセスでき、データ損失がゼロになります。 スタンバイ レプリカがアクティブ化され、バイナリ ログが適用されると、現在のスタンバイ レプリカがプライマリ サーバーの役割を担います。 DNS が更新され、クライアントが再接続するときに接続が新しいプライマリにリダイレクトされます。 フェールオーバーは、クライアント アプリケーションから完全に透過的で、ユーザーによる操作は必要ありません。 その後、高可用性ソリューションは、可能であれば古いプライマリ サーバーを回復し、スタンバイとして配置します。
 
アプリケーションは、データベース サーバー名を使用してプライマリ サーバーに接続されます。 スタンバイ レプリカの情報は、直接アクセスに対して公開されません。 コミットと書き込みは、プライマリ サーバーのローカル冗長ストレージ (LRS) ストレージでログ ファイルをフラッシュした後に確認されます。 プライマリ レプリカとスタンバイ レプリカが同じゾーンに配置されている場合、レプリケーションのラグは小さいので、同じ Azure 可用性ゾーン内に配置すると、アプリケーション サーバーとデータベース サーバー間の待機時間が短くなります。 特定の可用性ゾーンに依存するインフラストラクチャがダウンしているシナリオでは、同じゾーンのセットアップで高可用性は提供されません。   すべての依存サービスが、その可用性ゾーンに対してオンラインに戻るまで、ダウンタイムが発生します。
 
自動バックアップでは、スナップショットとログ バックアップの両方がローカル冗長ストレージ上でプライマリ データベース サーバーから実行されます。

>[!Note]
>ゾーン冗長 HA と同ゾーン HA の両方について、
>* 障害が発生した場合、スタンバイ レプリカがプライマリの役割を引き継ぐ時間は、スタンバイ上のバイナリ ログ アプリケーションによって異なります。 そのため、フェールオーバー時間を短縮するには、すべてのテーブルで主キーを使用することをお勧めします。 フェールオーバー時間の範囲は、通常、60 秒から 120 秒までです。 
>* スタンバイ サーバーは、読み取りまたは書き込み操作に使用できるものではなく、高速フェールオーバーを可能にするためのパッシブ スタンバイです。
>* 常に完全修飾ドメイン名 (FQDN) を使用してプライマリ サーバーに接続し、接続に IP アドレスを使用しないようにします。 フェールオーバーが発生した場合、プライマリおよびスタンバイ サーバーの役割が切り替えられると、DNS A レコードも変更される可能性があります。これにより、接続文字列で IP アドレスが使用されている場合に、アプリケーションが新しいプライマリ サーバーに接続できなくなる可能性があります。

## <a name="failover-process"></a>フェールオーバー プロセス 
 
### <a name="planned---forced-failover"></a>計画 - 強制フェイルオーバー
 
Azure Database for MySQL フレキシブル サーバー強制フェールオーバーによって手動で強制的にフェールオーバーできるため、この機能をアプリケーション シナリオでテストして、障害が発生した場合に備えることができます。 強制フェールオーバーでトリガーされるフェールオーバーによりスタンバイ レプリカが有効化されプライマリ サーバーになることで、スタンバイ サーバーはプライマリ サーバーに切り替わります。このとき DNS レコードが更新されることで、同じデータベース サーバー名が使用されます。 最初のプライマリ サーバーは再起動して、スタンバイ レプリカに切り替わります。 クライアント接続は切断されて、操作を再開するためには再接続が必要になります。 現在のワークロードと最後のチェックポイントに応じて、全体的なフェールオーバーの時間が測定されます。 一般的には、60 秒から 120 秒程度と思われます。
 
### <a name="unplanned--automatic-failover"></a>計画外 -自動フェールオーバー 
 
予定外のサービス ダウンタイムとしては、データベースの可用性に影響を与えるソフトウェアのバグや、コンピューティング、ネットワーク、ストレージ障害などによるインフラストラクチャの障害、停電があります。 データベースが使用できなくなった場合、スタンバイ レプリカへのレプリケーションは停止され、スタンバイ レプリカがアクティブ化されてプライマリ データベースになります。 DNS が更新された後、クライアントはデータベース サーバーに再接続され、操作を開始します。 全体的なフェールオーバー時間は、60 から 120 秒になると予想されます。 ただし、フェールオーバーの時点でのプライマリ データベース サーバー内のアクティビティ (大規模なトランザクションや復旧時間など) によっては、フェールオーバーがこれより長くなる可能性があります。

## <a name="high-availability-monitoring"></a>高可用性の監視
HA の正常性は、概要ページで継続的に監視され、報告されます。 さまざまなレプリケーションの状態を次に示します。

| **状態** | **説明** |
| :----- | :------ |
| <b>NotEnabled | ゾーン冗長による HA が有効ではありません |
| <b>ReplicatingData | スタンバイの作成後、そのスタンバイがプライマリ サーバーにキャッチアップ中です。 |
| <b>FailingOver | データベース サーバーは、プライマリからスタンバイにフェールオーバー中です。 |
| <b>Healthy | ゾーン冗長による HA は、安定した状態で正常です。 |
| <b>RemovingStandby | ユーザーの操作に基づいて、スタンバイ レプリカを削除中です。| 

##  <a name="limitations"></a>制限事項 
 
高可用性を使用する場合、次の点に注意してください。
* ゾーン冗長高可用性は、フレキシブル サーバー作成時にのみ設定できます。
* 高可用性は、バースト可能なコンピューティング レベルではサポートされません。
* 静的パラメーターの変更を取得するためにプライマリ データベース サーバーを再起動すると、スタンバイ レプリカも再起動されます。
* ゾーン冗長による高可用性サーバーに対して読み取りレプリカを構成することはサポートされていません。
* HA サーバーのデータイン レプリケーションはサポートされていません。 
* HA ソリューションで GTID が使用されている場合、GTID モードは ON に設定されます。 ワークロードに、[GTID を使用したレプリケーションに関する制限または制限](https://dev.mysql.com/doc/refman/5.7/en/replication-gtids-restrictions.html)が設定されているかを確認します。  
 
## <a name="frequently-asked-questions-faqs"></a>よく寄せられる質問 (FAQ)
 
**読み取りまたは書き込み操作にスタンバイ レプリカを使用できますか?** </br>
スタンバイ サーバーは、読み取りまたは書き込み操作に使用できるものではなく、高速フェールオーバーを可能にするためのパッシブ スタンバイです。</br>
**フェールオーバーが発生したときにデータが失われますか?**</br>
ZRS のログを使用すると、プライマリ サーバーが使用できない場合でもログにアクセスでき、データ損失がゼロになります。 スタンバイ レプリカが有効化され、バイナリ ログが適用されると、現在のスタンバイ レプリカがプライマリ サーバーの役割を担います。 </br>
**フェールオーバー後のアクションをユーザーが実行する必要がありますか?**</br>
フェールオーバーは、クライアント アプリケーションから完全に透過的で、ユーザーによる操作は必要ありません。 アプリケーションでは、接続の再試行ロジックを実装するだけで済みます。 </br>
**スタンバイ レプリカに特定のゾーンを選択しないとどうなりますか。後で変更することはできますか?**</br>
ゾーンが選択されていない場合は、プライマリ サーバーに使用されていないゾーンがランダムに選択されます。 後でゾーンを変更するには、[High Availability Mode (高可用性モード)] を [無効] に設定し、高可用性ブレードから選択したゾーンで [ゾーン冗長] に設定し直します。</br>
**プライマリ レプリカとスタンバイ レプリカ間のレプリケーションは同期されますか?**</br>
 プライマリとスタンバイ間のレプリケーション ソリューションは、MySQL の[準同期モード](https://dev.mysql.com/doc/refman/5.7/en/replication-semisync.html)と同様に考えることができます。 1 つのトランザクションがコミットされると、スタンバイにコミットする必要がありません。  ただし、プライマリが使用できない場合は、スタンバイがプライマリのデータ変更をすべてレプリケートできることを確認し、データが失われないようにできます。</br> 
**計画外のすべての障害が発生した場合に備えて、スタンバイ レプリカにフェールオーバーしますか?**</br>
データベースのクラッシュやノードの障害が発生すると、同じノードでフレキシブル サーバー VM が再起動します。 同時に、自動フェールオーバーがトリガーされます。 フェールオーバーが完了する前にフレキシブル サーバー VM の再起動が成功した場合、フェールオーバー操作は取り消されます。 時間がかからない方を検討して、どちらをプライマリ レプリカとスタンバイ レプリカにするかを決定します。</br>
**HA ソリューションを使用すると、パフォーマンスに影響がありますか?**</br>
ゾーン冗長 HA では、ネットワークの遅延が 2 ms から 4 ms 程度と比較的大きい可用性ゾーンをまたいでデータベース サーバーに接続するアプリケーションの場合、</br> 待機時間が 5 % から 10% 低下する可能性があります。 同一ゾーン HA では、プライマリ レプリカとスタンバイ レプリカが同じゾーンに配置されている場合、レプリケーションのラグは小さいので、同じ Azure 可用性ゾーン内に配置すると、アプリケーション サーバーとデータベース サーバー間の待機時間が短くなります。</br>
**HA サーバーのメンテナンスはどのように行われますか?**</br>
コンピューティングのスケーリングやマイナー バージョン アップグレードなどの予定イベントは、プライマリとスタンバイの両方で同時に発生します。 HA サーバーの [定期メンテナンス ウィンドウ](./concepts-maintenance.md)は、フレキシブル サーバーと同様に設定できます。 Azure Database for MySQL のフレキシブル サーバーで HA が無効になっている場合と同じ程度のダウンタイムが発生します。 フェールオーバー メカニズムを使用して HA サーバーのダウンタイムを削減することは、このロードマップに含まれており、すぐに使用できるようになります。 </br>
**HA サーバーを特定の時点へ復元 (PITR) できますか?**</br>
HA が有効になっている Azure database for MySQL のフレキシブル サーバーを、HA が無効になっている新しい Azure database for MySQL のフレキシブル サーバーに [PITR](./concepts-backup-restore.md#point-in-time-restore) を行うことができます。 移行元サーバーがゾーン冗長 HA で作成されている場合は、復元されたサーバーでゾーン冗長 HA または同じゾーン HA を後で有効にできます。 移行元サーバーが同じゾーン HA で作成されている場合は、復元されたサーバーでしか同じゾーンを有効にできません。</br>
**作成後にサーバーの HA を有効にできますか?**</br>
サーバーの作成後に同じゾーンの HA を有効にできますが、ゾーン冗長サーバーの HA オプションは、作成時にのみ選択できます。</br> 
**サーバーの post 作成で HA を無効にすることはできますか?** </br>
サーバー作成後に HA を無効にすると、すぐに課金が停止します  </br>
**ダウンタイムを抑制するにはどうすればよいですか?**</br>
HA 機能を使用しない場合でも、アプリケーションのダウンタイムを抑制する必要があります。 予定のパッチ、マイナー バージョン アップグレード、スケール コンピューティングなどのユーザーによる操作など、サービスのダウンタイムを計画することは、ダウンタイムが発生するため、定期メンテナンス ウィンドウの一部として実行できます。 Azure によって開始されるメンテナンス タスクがアプリケーションに与える影響を軽減するために、アプリケーションに対する影響が最も少ない曜日と時刻にタスクをスケジュールすることを選択できます。</br>
**HA が有効になっているサーバーのレプリカを読み取ることはできますか?**</br>
現在 HA が有効になっているサーバーは、読み取りレプリカをサポートしていません。 しかし、HA サーバー用の読み取りレプリカは、このロードマップに含まれており、間もなく利用頂けるように取り組んでいます。</br>
**HA サーバーにデータイン レプリケーションを使用できますか?**</br>
現在、HA サーバーのデータイン レプリケーションはサポートされていません。 しかし、HA サーバー用のデータイン レプリケーションは、このロードマップに含まれており、間もなく利用頂けるように取り組んでいます。 移行にデータイン レプリケーション機能を使用する場合は、次の手順に従います
* ゾーン冗長 HA が有効なサーバーを作成します
* HA を無効にします
* [データイン レプリケーションの設定](./concepts-data-in-replication.md)をアーティクルに従って行います (GTID_Mode がソース サーバーとターゲット サーバーで同じ設定になっていることを確認してください。)
* カットオーバー後に、データイン レプリケーション構成を削除します
* HA を有効にします

**サーバーの再起動中にスタンバイ サーバーにフェールオーバーできますか、またダウンタイムを抑制するためにスケール アップまたはスケール ダウンしていますか?** </br>
現時点では、スケール アップまたはスケール ダウン操作を実行すると、スタンバイとプライマリは同時にスケーリングされるので、フェイルオーバーでは対応できません。しかし、スタンバイのスケール アップを最初に行い、その後フェイルオーバーとプライマリのスケール アップを行えるようにすることがロードマップにありますが、まだサポートされていません。</br>


## <a name="next-steps"></a>次のステップ

- [ビジネス継続性](./concepts-business-continuity.md)について確認する
- [ゾーン冗長による高可用性](./concepts-high-availability.md)について確認する
- [バックアップと復旧](./concepts-backup-restore.md)について確認する