---
title: Azure Database for PostgreSQL (フレキシブル サーバー) でのバックアップと復元
description: Azure Database for PostgreSQL - フレキシブル サーバーでのバックアップと復元の概念について説明します
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 07/30/2021
ms.openlocfilehash: 8c6f3ebaa72457d93e4b3e491656f494511bd994
ms.sourcegitcommit: 0046757af1da267fc2f0e88617c633524883795f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/13/2021
ms.locfileid: "121745151"
---
# <a name="backup-and-restore-in-azure-database-for-postgresql---flexible-server"></a>Azure Database for PostgreSQL (フレキシブル サーバー) でのバックアップと復元

> [!IMPORTANT]
> Azure Database for PostgreSQL - フレキシブル サーバーはプレビュー段階です

バックアップは、あらゆるビジネス継続性戦略の重要な部分を形成します。 これは、不慮の破損や削除からデータを保護するのに役立ちます。 Azure Database for PostgreSQL - フレキシブル サーバーでは、サーバーが自動的にバックアップされ、バックアップは最大 35 日間保持されます。 復元時には、保持期間内で復元する日付と時刻を指定できます。 復元と復旧にかかる全体的な時間は、データベース ファイルのサイズと実行する復旧の量によって異なります。 

### <a name="backup-process-in-flexible-server"></a>フレキシブル サーバーでのバックアップ プロセス
最初のスナップショット バックアップは、フレキシブル サーバーの作成直後にスケジュールされます。 それ以降は、データ ファイルのスナップショット バックアップが毎日実行されます。 バックアップは、リージョン内のゾーン冗長ストレージに格納されます。 トランザクション ログ (先書きログ - WAL) も継続的にアーカイブされるため、最後にコミットされたトランザクションに復元することができます。 これらのデータとログのバックアップを使用すると、サーバーを、バックアップの構成済みリテンション期間内の任意の時点に復元できます。 すべてのバックアップが、AES 256 ビット暗号化を使用して暗号化されます。

データベースが高可用性で構成されている場合は、毎日のスナップショットがプライマリから実行され、継続的なログ バックアップがスタンバイから実行されます。

> [!IMPORTANT]
>停止したサーバーではバックアップは実行されません。 ただし、データベースが 7 日後に自動的に開始されるかユーザーによって開始されると、バックアップが再開されます。

バックアップは、フレキシブル サーバー内での復元操作にのみ使用できます。 フレキシブル サーバーにデータをエクスポートまたはインポートする場合は、[ダンプと復元](../howto-migrate-using-dump-and-restore.md)手法を使用します。


### <a name="backup-retention"></a>バックアップ保有期間

バックアップは、サーバーのバックアップ保持期間の設定に基づいて保持されます。 7 日間から 35 日間までの保持期間を選択できます。 既定の保持期間は 7 日に設定されています。 サーバーの作成時に保持期間を設定することも、後で更新することもできます。 停止したサーバーでもバックアップは保持されます。

バックアップの保持期間によって、現在からどのくらい遡ってポイントインタイム リストアを取得できるかが管理されます。ポイントインタイム リストアは使用可能なバックアップに基づいているためです。 バックアップの保有期間は、復元の観点から回復期間として扱うこともできます。 バックアップの保持期間内の特定の時点に復旧するために必要なすべてのバックアップは、バックアップ ストレージに保持されます。 たとえば、バックアップの保持期間が 7 日間に設定されている場合、回復期間は過去 7 日間と見なされます。 このシナリオでは、過去 7 日間のサーバーを復元および復旧するために必要なすべてのデータとログが保持されます。 


### <a name="backup-storage-cost"></a>バックアップ ストレージのコスト

フレキシブル サーバーを使用すると、プロビジョニングされているサーバー ストレージの最大 100% までが、バックアップ ストレージとして追加コストなしで提供されます。 バックアップ ストレージを追加で使用した場合は、1 か月ごとに GB 単位で請求されます。 たとえば、サーバーを 250 GiB のストレージでプロビジョニングした場合は、250 GiB のバックアップ ストレージ容量を追加料金なしで利用できます。 毎日のバックアップ使用量が 25 GiB の場合は、最大 10 日間の無料バックアップ ストレージを使用できます。 250 GiB を超えるバックアップ ストレージの使用は、[価格モデル](https://azure.microsoft.com/pricing/details/postgresql/)に従って課金されます。

Azure portal で "[使用されたバックアップ ストレージ](../concepts-monitoring.md)" メトリックを使用して、サーバーによって使用されるバックアップ ストレージを監視できます。 このバックアップ ストレージの使用量のメトリックは、サーバーに設定されているバックアップ保持間に基づいて保持されているすべてのデータベースのバックアップとログ バックアップによって使用されるストレージの合計を表します。  サーバーで大量のトランザクション アクティビティが発生すると、データベースの合計サイズに関係なく、バックアップ ストレージの使用量が増加する可能性があります。

バックアップ ストレージ コストを制御する主な方法は、適切なバックアップ保有期間を設定し、目的の回復目標を達成するための適切なバックアップ冗長オプションを選択することです。

> [!IMPORTANT]
> 現在、geo 冗長バックアップは、フレキシブル サーバーではサポートされていません。

## <a name="point-in-time-restore-overview"></a>ポイントインタイム リストアの概要

フレキシブル サーバーでは、ポイントインタイム リストアを実行すると、ソース サーバーと同じリージョンに、フレキシブル サーバーのバックアップから新しいサーバーが作成されます。 価格レベル、コンピューティング世代、仮想コア数、ストレージ サイズ、バックアップの保持期間、およびバックアップ冗長オプションについては、ソース サーバーの構成を使用して作成されます。 また、VNET やファイアウォールの設定などのタグと設定は、ソース サーバーから継承されます。 

 > [!IMPORTANT]
> ゾーン冗長の高可用性を使用して構成されたフレキシブル サーバーを復元する場合、復元されたサーバーは、高可用性なしで、プライマリ サーバーと同じリージョンに構成されます。 

 ### <a name="restore-process"></a>復元プロセス

物理データベース ファイルは、最初にスナップショット バックアップからサーバーのデータの場所に復元されます。 目的の時点より前に作成された適切なバックアップが自動的に選択され、復元されます。 その後、WAL ファイルを使用して復旧プロセスが開始されて、データベースを一貫性のある状態にします。 

 たとえば、バックアップが毎晩、午後 11 時に実行されているとします。 復元ポイントが 2020 年 8 月 15 日午前 10 時の場合は、2020 年 8 月 14 日の日次バックアップが復元されます。 データベースは、2020 年 8 月 25 日午前 10 時までは、8 月 24 日午後 11 時から 8 月 25 日午前 10 時までのトランザクション ログのバックアップを使用して復旧されます。 

 データベース サーバーを復元するには、[こちらの手順](./how-to-restore-server-portal.md)を参照してください。

> [!IMPORTANT]
> フレキシブル サーバーでの復元操作では、新しいデータベース サーバーが作成され、既存のデータベース サーバーは上書きされません。

ポイントインタイム リストアは複数のシナリオで役に立ちます。 たとえば、ユーザーが誤ってデータを削除したとき、重要なテーブルやデータベースを削除したとき、またはアプリケーションの不具合が原因で、適切なデータが不適切なデータで誤って上書きされた場合などです。 トランザクション ログの継続的バックアップによって、最後のトランザクションに復元できるようになります。

最新の復元ポイントとカスタム復元ポイントのどちらかを選択できます。

-   **最新の復元ポイント (現在)** : これは、サーバーを最新の時点に復元できる、既定のオプションです。 

-   **カスタム復元ポイント**:このオプションを使用すると、このフレキシブル サーバーに定義されている保持期間内の特定の時点を選択できます。 既定では、UTC の最新の時刻が自動選択され、テスト目的で最後にコミットされたトランザクションに復元する場合に便利です。 必要に応じて、他の日付と時刻を選択することもできます。 

復旧の推定所要時間は、データベースのサイズ、処理するトランザクション ログの量、ネットワーク帯域幅、同じリージョン内で同時に復旧するデータベースの合計数など、複数の要因によって異なります。 全体的な復旧時間は、通常は数分から数時間かかります。

サーバーを VNET 内に構成している場合は、同じ VNET または別の VNET に復元できます。 ただし、パブリック アクセスには復元できません。 同様に、パブリック アクセスを使用してサーバーを構成した場合、プライベート アクセスには復元できません。


> [!IMPORTANT]
> 削除したサーバーは、復元 **できません**。 サーバーを削除すると、そのサーバーに属するデータベースもすべて削除され、復元できなくなります。 管理者は、デプロイ後の誤削除や予期せぬ変更からサーバーのリソースを保護するために、[管理ロック](../../azure-resource-manager/management/lock-resources.md)を利用できます。

## <a name="perform-post-restore-tasks"></a>復元後のタスクの実行

データベースを復元した後、次のタスクを実行して、ユーザーとアプリケーションを元に戻して実行することができます。

-   元のサーバーを新しいサーバーで置き換える場合は、クライアントとクライアント アプリケーションを新しいサーバーにリダイレクトする。

-   ユーザーが接続できるように、適切なサーバー レベルのファイアウォールと VNet ルールが適用されていることを確認します。 これらのルールは配信元のサーバーからはコピーされません。
  
-   復元されたサーバーのコンピューティングは、必要に応じてスケールアップ/スケールダウンできます。

-   適切なログインとデータベース レベルのアクセス許可が適切に指定されていることを確認する。

-   必要に応じて、アラートを構成する。
  
-  高可用性で構成されたデータベースを復元した場合、および復元されたサーバーを高可用性で構成する場合は、[こちらの手順](./how-to-manage-high-availability-portal.md)に従うことができます。

## <a name="frequently-asked-questions"></a>よく寄せられる質問

### <a name="backup-related-questions"></a>バックアップに関連する質問

* **サーバーのバックアップは Azure でどのように処理されますか?**
 
    既定では、Azure Database for PostgreSQL によって、サーバー全体 (作成されたすべてのデータベースを含む) の自動バックアップが有効になります。保有期間は、既定では 7 日間です。 データベースの毎日の増分スナップショットが実行されます。 ログ (WAL) ファイルは、Azure BLOB に継続的にアーカイブされます。

* **これらの自動バックアップが長期間保有されるように構成できますか?**
  
    いいえ。 現在サポートされているのは、最大 35 日間のデータ保有のみです。 手動バックアップを行い、それを長期保有の要件に使用できます。

* **Postgres サーバーの手動バックアップの実行方法を教えてください。**
  
    手動でのバックアップは、[こちら](https://www.postgresql.org/docs/current/app-pgdump.html)に記載されている PostgreSQL ツール pg_dump を使用して行うことができます。 たとえば、バックアップに使用できるこちらの[更新または移行に関するドキュメント](../howto-migrate-using-dump-and-restore.md)も参照できます。 Azure Database for PostgreSQL を BLOB ストレージにバックアップする場合は、「[Azure Database for PostgreSQL を BLOB ストレージにバックアップする](https://techcommunity.microsoft.com/t5/azure-database-for-postgresql/backup-azure-database-for-postgresql-to-a-blob-storage/ba-p/803343)」という Tech Community ブログを参照してください。 

* **サーバーのバックアップの時間帯はどうなっていますか? カスタマイズできますか?**
  
    バックアップの時間帯は本質的に Azure によって管理されており、カスタマイズできません。 初回の完全スナップショット バックアップは、サーバーの作成直後にスケジュールされます。 後続のスナップショット バックアップは、1 日に 1 回実行される増分バックアップです。

* **バックアップは暗号化されますか?**
  
    はい。 クエリの実行中に作成されるすべての Azure Database for PostgreSQL データ、バックアップ、一時ファイルは、AES 256 ビット暗号化を使用して暗号化されます。 ストレージの暗号化は常にオンになっており、無効にすることはできません。 

* **サーバー内の単一または少数のデータベースを復元できますか?**
  
    単一または少数のデータベースやテーブルの復元は直接サポートされていません。 ただし、サーバー全体を新しいサーバーに復元してから、必要なテーブルまたはデータベースを抽出して、サーバーにインポートする必要があります。

* **バックアップの進行中はサーバーを使用できますか?**
    はい。 バックアップは、スナップショットを使用したオンライン操作です。 スナップショット操作には数秒しかかからず、運用環境のワークロードには影響しないため、サーバーの高可用性が確保されます。 

* **サーバーのメンテナンス期間を設定するときに、バックアップの時間帯を考慮する必要がありますか?**
  
    いいえ。 バックアップは管理サービスの一部として内部的にトリガーされ、管理されたメンテナンス期間には関係ありません。

* **自動バックアップはどこに格納され、その保有期間はどのように管理できますか?**
  
    Azure Database for PostgreSQL では、サーバー バックアップは自動的に作成され、複数のゾーンがサポートされているリージョン内のゾーン冗長ストレージ、または複数のゾーンがまだサポートされていないリージョン内のローカル冗長ストレージに自動的に格納されます。 これらのバックアップ ファイルをエクスポートすることはできません。 バックアップは、サーバーを特定の時点に復元するためにのみ使用できます。 バックアップの既定のリテンション期間は 7 日です。 必要に応じて、バックアップのリテンション期間を最大 35 日に構成できます。

* **HA が有効になっているサーバーではバックアップはどのように実行されますか?**
  
    フレキシブル サーバーのデータ ボリュームは、プライマリ サーバーからマネージド ディスクの増分スナップショットを使用してバックアップされます。 WAL バックアップは、プライマリ サーバーまたはスタンバイ サーバーから実行されます。

* **サーバーでバックアップが実行されていることを確認するにはどうすればよいですか?**

    有効なバックアップの可用性を確認する最良の方法は、ポイントインタイム リストアを定期的に実行し、バックアップが有効で復元可能であることを確認することです。 バックアップ操作またはファイルは、エンド ユーザーには公開されません。

* **バックアップの使用量はどこで確認できますか?**
  
    Azure portal の [監視] の下にある [メトリック] をクリックすると、[バックアップの利用状況] メトリックが表示され、バックアップの合計使用量を監視できます。

* **サーバーを削除した場合、バックアップはどうなりますか?**
  
    サーバーを削除すると、そのサーバーに属するバックアップもすべて削除され、復旧できなくなります。 管理者は、デプロイ後の誤削除や予期せぬ変更からサーバーのリソースを保護するために、管理ロックを利用できます。

* **停止したサーバーのバックアップはどのように保有されますか?**

    停止したサーバーに対して、新しいバックアップは実行されません。 サーバーを停止した時点でのすべての古いバックアップ (保有期間内のもの) は、サーバーが再起動されるまで保有されます。その後、アクティブなサーバーのバックアップの保有は、そのバックアップ保有期間によって管理されます。

* **バックアップの課金と請求はどのように行われますか?**
  
    フレキシブル サーバーを使用すると、プロビジョニングされているサーバー ストレージの最大 100% までが、バックアップ ストレージとして追加コストなしで提供されます。 バックアップ ストレージを追加で使用した場合は、価格モデルに基づき、1 か月ごとに GB 単位で請求されます。 また、バックアップ ストレージの課金には、使用されるバックアップ ストレージの合計使用量に直接影響するサーバー上のトランザクション アクティビティとは別に、選択されたバックアップ保有期間と選択されたバックアップ冗長性オプションも関与します。

* **停止しているサーバーについては、どのように請求されますか?**
  
    サーバー インスタンスが停止している間は、新しいバックアップは実行されません。 プロビジョニングされたストレージとバックアップ ストレージ (指定した保有期間内に格納されたバックアップ) に対して課金されます。 無料のバックアップ ストレージは、プロビジョニングされているデータベースのサイズに制限され、超過したバックアップ データはバックアップ価格を使用して課金されます。

* **ゾーン冗長の高可用性でサーバーを構成しました。2 つのバックアップが取得され、2 回課金されますか?**
  
    いいえ。 HA か非 HA サーバーかに関係なく、1 セットのバックアップ コピーのみが保持され、課金されるのは 1 回のみです。

### <a name="restore-related-questions"></a>復元に関連する質問

* **サーバーを復元するにはどうすればよいですか?**

    Azure ではポイントインタイム リストアがサポートされ (すべてのサーバーが対象)、ユーザーは、Azure portal、Azure CLI および API を使用して、最新またはカスタムの復元ポイントに復元できます。 

    pg_dump などのツールを使用して手動で作成したバックアップからサーバーを復元するには、まず、フレキシブル サーバーを作成し、[pg_restore](https://www.postgresql.org/docs/current/app-pgrestore.html) を使用してデータベースをサーバーに復元します。

* **同じリージョン内の別の可用性ゾーンに復元できますか?**
  
    はい。 リージョンで複数の可用性ゾーンがサポートされている場合、バックアップは ZRS アカウントに格納され、別のゾーンに復元できます。 

* **ポイントインタイム リストアにはどのくらいの時間がかかりますか? 復元で非常に時間がかかっているのですが、それはなぜですか?**
  
    スナップショットからのデータ復元操作は、データ サイズでは決まりません。ログ (再生するトランザクション アクティビティ) を適用する復旧プロセスのタイミングは、要求された日付/時刻の前のバックアップと処理するログの量によって異なる可能性があります。 これは、同じゾーン内または別のゾーンへの復元のどちらにも適用されます。 
 
* **HA が有効になっているサーバーを復元した場合、復元サーバーは自動的に高可用性で構成されますか?**
  
    いいえ。 サーバーは、単一インスタンスのフレキシブル サーバーとして復元されます。 復元が完了したら、必要に応じて、サーバーを高可用性で構成できます。

* **VNET 内にサーバーを構成しました。別の VNET に復元できますか?**
  
    はい。 復元時に、復元先となる別の VNET を選択してください。

* **パブリック アクセス サーバーを VNET に復元する (またはその逆) は可能ですか?**

    いいえ。 現在、パブリック アクセスとプライベート アクセス間でのサーバーの復元はサポートされていません。

* **復元操作を追跡するにはどうすればいいですか?**
  
    現在、復元操作を追跡する方法はありません。 アクティビティ ログを監視して、操作が進行中か、または完了しているかを確認できます。


## <a name="next-steps"></a>次のステップ

-   [ビジネス継続性](./concepts-business-continuity.md)について確認する
-   [ゾーン冗長による高可用性](./concepts-high-availability.md)について確認する
-   [復元方法](./how-to-restore-server-portal.md)を確認します