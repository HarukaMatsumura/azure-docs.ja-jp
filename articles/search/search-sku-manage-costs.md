---
title: 容量とコストを見積もる
titleSuffix: Azure Cognitive Search
description: Azure のインフラストラクチャとツールや、リソースをより効果的に使用するためのベストプラクティスを含め、容量を見積もり、検索サービスのコストを管理するためのガイダンスを示します。
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 12/15/2020
ms.openlocfilehash: d48ae71a979a2d0f1457b0cefa8a98a02710dd96
ms.sourcegitcommit: 77ab078e255034bd1a8db499eec6fe9b093a8e4f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/16/2020
ms.locfileid: "97577579"
---
# <a name="how-to-estimate-capacity-and-costs-of-an-azure-cognitive-search-service"></a>Azure Cognitive Search サービスの容量とコストを見積もる方法

Azure Cognitive Search の容量計画の一環として、次のガイダンスを参考にしてコストを削減し、コストをより効果的に管理できます。

+ 帯域幅の料金を最小限に抑えるかなくすために、すべてのリソースを同一のリージョンか可能な限り少ないリージョンに作成します。

+ Azure Cognitive Search、Cognitive Services、ご利用のソリューションで使用されているその他の Azure サービスなど、すべてのサービスを 1 つのリソース グループに統合します。 Azure portal で、リソース グループを見つけ、 **[コスト管理]** のコマンドを使用して、実際の支出と予想される支出を把握します。

+ フロントエンド アプリケーションには、要求と応答がデータ センターの境界内に収まるように Azure Web アプリを検討します。

+ インデックス作成などのリソースを大量に消費する操作に対してはスケールアップし、通常のクエリ ワークロードに対して再調整してスケールダウンします。 Azure Cognitive Search の最小構成 (1 つのパーティションと 1 つのレプリカで構成された 1 つの SU) から開始し、ユーザー アクティビティを監視して、容量の増加に対するニーズを示す使用パターンを特定します。 予測可能なパターンがある場合は、スケールをアクティビティと同期できることがあります (これを自動化するにはコードを記述する必要があります)。

課金対象のイベント、請求の計算式、課金対象のレートについては、[価格レベルの選択](search-sku-tier.md)に関するページをご覧ください。 また、支出に関連する組み込みツールと機能については、[課金とコスト管理](../cost-management-billing/cost-management-billing-overview.md) に関するページをご覧ください。

検索サービスを一時的にシャットダウンすることはできません。 専用リソースは常に動作し、サービスの有効期間中、お客様専用として割り当てられています。 サービスの削除は永続的なものであり、関連付けられているデータも削除されます。

サービス自体に関して、課金を抑える唯一の方法は、レプリカとパーティションを、まだ許容可能なパフォーマンスと [SLA コンプライアンス](https://azure.microsoft.com/support/legal/sla/search/v1_0/)を提供する低いレベルに下げるか、より低いレベルでサービスを作成することです (S1 の時間あたりの料金は S2 または S3 の料金よりも低くなります)。 負荷予測の下限でサービスをプロビジョニングすると仮定した場合、サービスが拡大したら、2 番目に高いレベルのサービスを作成し、その 2 番目のサービスでインデックスを再構築してから、最初のサービスを削除することができます。

## <a name="how-to-evaluate-capacity-requirements"></a>容量の要件を評価する方法

Azure Cognitive Search では、容量は *レプリカ* と *パーティション* で構成されています。

+ レプリカは、検索サービスのインスタンスです。 各レプリカは、負荷分散されたインデックスのコピーを 1 つホストします。 たとえば、6 つのレプリカが存在するサービスでは、各インデックスの 6 つのコピーがサービスに読み込まれています。

+ パーティションにインデックスが格納され、検索可能なデータが自動的に分割されます。 パーティションが 2 つの場合、インデックスは 2 つに分割され、パーティションが 3 つの場合は 3 分の 1 に分割されるといったぐあいです。 容量の点では、"*パーティション サイズ*" が、レベル間で大きな違いのある機能です。

> [!NOTE]
> すべての Standard および Storage Optimized レベルで、[レプリカとパーティションを柔軟に組み合わせる](search-capacity-planning.md#chart)ことができます。そのバランスを変更することにより、[システムを速度またはストレージ量の点で最適化](search-performance-optimization.md)できます。 Basic レベルでは、最大で 3 つのレプリカが使用できるため可用性が高くなりますが、パーティションは 1 つのみです。 Free レベルでは、専用のリソースが提供されません。コンピューティング リソースは複数のサブスクライバー間で共用されます。

### <a name="evaluating-capacity"></a>容量の評価

容量とサービスの実行コストは密接に関係しています。 サービス レベルでは、ストレージとコンテンツ (インデックスの数など) の 2 つのレベルに制限が課されます。 先に上限に達した方が実質的な制限になるため、両方を考慮する必要があります。

通常、必要となるインデックスの数は、ビジネス要件によって規定されます。 たとえば、ドキュメントの大規模なリポジトリ用にグローバル インデックスが必要な場合があります。 また、リージョン、アプリケーション、またはビジネス分野に基づいて複数のインデックスが必要な場合があります。

インデックスのサイズを特定するには、インデックスを 1 つ[構築](search-what-is-an-index.md)する必要があります。 そのサイズは、インポートされたデータと、suggester、フィルタリング、並べ替えの有効化など、インデックス構成に基づきます。

全文検索の場合、主要データ構造は[転置インデックス](https://en.wikipedia.org/wiki/Inverted_index)構造であり、ソース データとは異なる特性があります。 転置インデックスのサイズと複雑性はコンテンツによって決まり、必ずしもそれにフィードするデータ量によって決まるものではありません。 冗長性の高い大規模なデータ ソースは、変動の多いコンテンツを含む小さいデータセットよりも、インデックスのサイズが小さくなることがあります。 そのため、元のデータ セットのサイズに基づいてインデックスのサイズを推測できることはほとんどありません。

> [!NOTE] 
> インデックスとストレージの将来のニーズの見積もりは、当て推量のように感じられるかもしれませんが、行う価値があります。 あるレベルの容量が少なすぎることがわかった場合は、それより上のレベルで新しいサービスをプロビジョニングしたうえで、[インデックスを再読み込み](search-howto-reindex.md)する必要があります。 特定のレベルから別のレベルへのサービスのインプレース アップグレードを実行することはできません。
>

## <a name="estimate-with-the-free-tier"></a>Free レベルでの見積もり

容量を見積もる方法の 1 つは、まず Free レベルを使用することです。 Free サービスでは、最大 3 つのインデックス、50 MB のストレージ、および 2 分間のインデックス作成時間が提供されます。 これらの制約の中で予想インデックス サイズを見積もることは簡単ではない可能性がありますが、その手順は次のとおりです。

+ [Free サービスを作成](search-create-service-portal.md)します。
+ 小さな代表的なデータセットを準備します。
+ [ポータルで最初のインデックスを構築](search-get-started-portal.md)し、そのサイズをメモします。 機能と属性はストレージに影響を与えます。 たとえば、suggester (Search-as-you-type クエリ) を追加すると、ストレージ要件が増加します。 同じデータ セットを使用する場合、各フィールドに異なる属性を設定してインデックスの複数のバージョンを作成し、ストレージ要件がどのように変化するかを確認してみてください。 詳細については、[基本的なインデックスの作成に関するページの「ストレージへの影響」](search-what-is-an-index.md#index-size)を参照してください。

大まかな見積もりが得られたら、2 つのインデックス (開発用と運用用) の量を予測するためにこの値を 2 倍にし、それに応じてレベルを選択します。

## <a name="estimate-with-a-billable-tier"></a>課金対象レベルでの見積もり

専用のリソースでは、より長いサンプリングと処理時間に対応でき、開発段階でのインデックスの量、サイズ、クエリ量についてより現実的な見積もりを求めることができます。 課金対象のレベルから始め、開発プロジェクトが成熟するのに応じて再評価するお客様もいます。

1. [各レベルのサービス制限を確認](./search-limits-quotas-capacity.md#index-limits)して、より低いレベルで、必要なインデックス数に対応できるかどうかを判断してください。 Basic、S1、S2 レベルでのインデックス制限は、それぞれ 15、50、200 です。 Storage Optimized レベルは、少数の非常に大きいインデックスをサポートするように設計されているため、10 インデックスに制限されています。

1. [課金対象レベルでサービスを作成します](search-create-service-portal.md)。

    + 予想される負荷がわからない場合は、Basic または S1 の低いレベルで始めます。
    + サイズの大きなインデックスの作成とクエリの負荷への対応が必要になることがわかっている場合は、S2 または S3 の高レベルから始めます。
    + 社内のビジネス アプリケーションのように、インデックスを付けるデータの量が多く、クエリの負荷が比較的低い場合は、Storage Optimized (L1 または L2) から始めます。

1. [最初のインデックスを構築](search-what-is-an-index.md)して、ソース データがどのようにインデックスに変換されるかを特定します。 これは、インデックスのサイズを推測する唯一の方法です。

1. ポータルで、[ストレージ、サービス制限、クエリ量、および待機時間を監視](search-monitor-usage.md)します。 秒あたりのクエリ数、調整されたクエリ数、および検索の待ち時間がポータルに表示されます。 これらすべての値が、適切なレベルを選択したかどうかを判断するために役立ちます。 

インデックスの数とサイズは、分析にとってどちらも同様に重要です。 ストレージ (パーティション) を使い果たしたか、リソース (インデックス、インデクサーなど) の上限に達したか、どちらか早い方で上限に達したとされるためです。 ポータルの [概要] ページでは、現在の使用状況と最大制限が並んで表示されるため、両方を追跡できます。

> [!NOTE]
> ドキュメントに余分なデータが含まれている場合は、ストレージの必要量が多くなる可能性があります。 ドキュメントには、検索機能に必要なデータのみが含まれていることが理想的な状態です。 バイナリ データは検索できないため、別途保存する必要があります (おそらく Azure テーブルまたは BLOB ストレージに)。 その後、外部データへの URL 参照を保持するためのフィールドをインデックスに追加する必要があります。 個々のドキュメントの最大サイズは 16 MB です (1 回の要求で複数のドキュメントを一括アップロードする場合は、それより小さくなります)。 詳細については、[Azure Cognitive Search サービスの制限](search-limits-quotas-capacity.md)に関する記事を参照してください。
>

**クエリ数に関する考慮事項**

クエリ/秒 (QPS) は、パフォーマンスのチューニング中の重要なメトリックですが、一般に、最初からクエリ数が多いことが予想される場合は、レベルに関する考慮事項に過ぎません。

Standard レベルでは、レプリカとパーティションのバランスを取ることができます。 負荷分散用のレプリカを追加したり、並列処理用のパーティションを追加したりすることで、クエリのターンアラウンドを向上させることができます。 その後、サービスがプロビジョニングされた後に、パフォーマンスをチューニングできます。

最初から大量のクエリ数が継続することが予想される場合は、より強力なハードウェアを使用する、より高い Standard レベルを検討してください。 その後、これらのクエリ数が発生しなかった場合は、パーティションとレプリカをオフラインにするか、より低いレベルのサービスに切り替えることができます。 クエリ スループットの計算方法の詳細については、[Azure Cognitive Search のパフォーマンスと最適化](search-performance-optimization.md)に関する記事を参照してください。

Storage Optimized レベルは、大規模なデータ ワークロードに適しており、クエリの待ち時間要件がそれほど重要でない場合に、より全体的に利用可能なインデックス ストレージをサポートします。 それでも、負荷分散のためにはレプリカを追加し、並列処理のためにはパーティションを追加する必要があります。 その後、サービスがプロビジョニングされた後に、パフォーマンスをチューニングできます。

**サービスレベル アグリーメント**

Free レベルおよびプレビュー機能には、[サービスレベル アグリーメント (SLA)](https://azure.microsoft.com/support/legal/sla/search/v1_0/) がありません。 課金対象のすべてのレベルで、SLA が有効になるのは、サービスにとって十分な冗長性がプロビジョニングされるときです。 クエリ (読み取り) の SLA には複数のレプリカが必要です。 クエリとインデックス作成 (読み取り/書き込み) の SLA には 3 つ以上のレプリカが必要です。 パーティションの数は、SLA に影響しません。

## <a name="tips-for-tier-evaluation"></a>レベルの評価に関するヒント

+ クエリに関するメトリックを構築し、利用パターン (業務時間中のクエリ数、オフピーク時のインデックス作成) に関するデータを収集します。 このデータを使用して、サービス プロビジョニングに関する決定に役立つ情報を提供します。 時間ごと、または毎日の周期では実用的でありませんが、パーティションやリソースを動的に調節して、クエリ数の計画された変化に対応できます。 計画外ではあっても持続した変化に対応することもできます。ただし、対処する間、そのレベルが保持される場合です。

+ 過小なプロビジョニングの唯一の欠点として、実際の要件が予測より大きかった場合にサービスを中断する必要があるということに注意してください。 サービスの中断を回避するには、より高いレベルで新しいサービスを作成し、すべてのアプリと要求が新しいエンドポイントを指すようになるまで並行して実行します。

## <a name="next-steps"></a>次のステップ

Free レベルから始め、データのサブセットを使用して最初のインデックスを構築することで、その特性を理解します。 Azure Cognitive Search のデータ構造は、転置インデックス構造です。 転置インデックスのサイズと複雑性はコンテンツによって決まります。 冗長性の高いコンテンツでは、不規則なコンテンツよりもインデックスのサイズが小さくなる傾向があります。 そのため、インデックス ストレージの要件を決定するのは、データ セットのサイズではなく、コンテンツの特性です。

インデックス サイズの最初の見積もり後、この記事で説明されているレベルのいずれかの[課金対象のサービスをプロビジョニング](search-create-service-portal.md)します (Basic、Standard、または Storage Optimized)。 データのサイズ決定に対する人為的な制約を緩和し、検索可能にする必要があるすべてのデータが含まれるよう、[インデックスを再構築](search-howto-reindex.md)します。

必要なパフォーマンスとスケールに合わせて[パーティションとレプリカを割り当て](search-capacity-planning.md)ます。

パフォーマンスと容量に問題なければ完了です。 問題がある場合は、より密接にニーズに適合するよう、別のレベルで検索サービスを再作成します。

> [!NOTE]
> ご不明な点がある場合は、[StackOverflow](https://stackoverflow.com/questions/tagged/azure-search) に投稿するか、[Azure サポートにお問い合わせ](https://azure.microsoft.com/support/options/)ください。