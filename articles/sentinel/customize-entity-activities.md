---
title: Azure Sentinel エンティティ タイムラインのアクティビティをカスタマイズする | Microsoft Docs
description: Azure Sentinel のエンティティ ページのタイムラインで追跡および表示される内容に、カスタマイズしたアクティビティを追加します
services: sentinel
documentationcenter: na
author: yelevin
manager: rkarlin
editor: ''
ms.service: azure-sentinel
ms.subservice: azure-sentinel
ms.devlang: na
ms.topic: how-to
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 05/05/2021
ms.author: yelevin
ms.openlocfilehash: 737fce0dff06e8af5599158bb7b6e795bf43ba0c
ms.sourcegitcommit: ce9178647b9668bd7e7a6b8d3aeffa827f854151
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/12/2021
ms.locfileid: "109811809"
---
# <a name="customize-activities-on-entity-page-timelines"></a>エンティティ ページのタイムラインのアクティビティをカスタマイズする

> [!IMPORTANT]
>
> - アクティビティのカスタマイズは、**プレビュー** 段階です。 ベータ版、プレビュー版、または一般提供としてまだリリースされていない Azure の機能に適用されるその他の法律条項については、「[Microsoft Azure プレビューの追加使用条件](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)」を参照してください。

## <a name="introduction"></a>はじめに

既定で用意されている Azure Sentinel のタイムラインで追跡および表示されるアクティビティに加えて、追跡したいその他のアクティビティを作成して、それらもタイムラインに表示できます。 接続されている任意のデータ ソースのエンティティ データのクエリに基づいて、カスタマイズされたアクティビティを作成できます。 たとえば、次の方法でこの機能を使用できます。

- 既定で用意されている既存のアクティビティ テンプレートを変更して、エンティティ タイムラインに新しいアクティビティを追加する。

- カスタム ログから新しいアクティビティを追加する。たとえば、特定の建物にユーザーが出入りするアクティビティを、物理的なアクセス制御ログからそのユーザーのタイムラインに追加できます。

## <a name="getting-started"></a>作業の開始

1. Azure Sentinel のナビゲーション メニューから、 **[Entity behavior]\(エンティティ動作\)** を選択します。

1. **[エンティティの動作]** ブレードで、画面の上部にある **[エンティティ ページのカスタマイズ]** を選択します。

    :::image type="content" source="./media/customize-entity-activities/entity-behavior-blade.png" alt-text="[エンティティの動作] ページ":::

1. 表示されるページの **[自分のアクティビティ]** タブに、自分が作成したアクティビティの一覧が表示されます。 **[アクティビティ テンプレート]** タブには、Microsoft のセキュリティ研究員によって既定で用意されているアクティビティのコレクションが表示されます。 これらは、エンティティ ページのタイムラインで既に追跡および表示されているアクティビティです。

## <a name="create-an-activity-from-a-template"></a>アクティビティをテンプレートから作成する

1. **[アクティビティ テンプレート]** タブをクリックすると、既定で使用できるさまざまなアクティビティが表示されます。 エンティティの種類とデータ ソースでこの一覧をフィルター処理できます。 一覧からアクティビティを選択すると、プレビュー ペインに次の詳細が表示されます。

    -  アクティビティの説明

    - アクティビティを構成するイベントを提供するデータ ソース

    - 生データ内のエンティティを識別するために使用される識別子

    - このアクティビティの検出につながるクエリ

1. プレビュー ペインの下部にある **[アクティビティの作成]** ボタンをクリックして、アクティビティ作成ウィザードを開始します。 

1. **[アクティビティ ウィザード - テンプレートからの新しいアクティビティの作成]** が開きます。フィールドにはテンプレートのデータが既に設定されています。 必要に応じて、 **[全般]** および **[アクティビティの構成]** タブを変更できます。

1. 問題がなければ、 **[確認と作成]** タブを選択します。 **[検証に成功しました]** というメッセージが表示されたら、下部にある **[作成]** ボタンをクリックします。

## <a name="create-an-activity-from-scratch"></a>アクティビティを最初から作成する

[アクティビティ] ページの上部にある **[アクティビティの追加]** をクリックして、アクティビティ作成ウィザードを開始します。

**[アクティビティ ウィザード - 新しいアクティビティの作成]** が開きます。フィールドは空白になっています。

### <a name="general-tab"></a>[全般] タブ
1. アクティビティの名前を入力します (例: "グループに追加されたユーザー")。

1. アクティビティの説明を入力します (例: "Windows イベント ID 4728 に基づくユーザー グループ メンバーシップの変更")。

1. このクエリで追跡するエンティティの種類 (ユーザーまたはホスト) を選択します。

1. 追加のパラメーターでフィルター処理すると、クエリを絞り込んだり、パフォーマンスを最適化したりするのに役立ちます。 たとえば、**IsDomainJoined** パラメーターを選択して、その値を **True** に設定すると、Active Directory ユーザーをフィルター処理できます。

1. アクティビティの初期状態を **[有効]** または **[無効]** に選択できます。

### <a name="activity-configuration-tab"></a>[アクティビティの構成] タブ

#### <a name="writing-the-activity-query"></a>アクティビティ クエリの作成

こちらでは、選択したエンティティのアクティビティを検出するために使用する KQL クエリを作成するか貼り付けます。そして、タイムラインでそれをどのように表示するかを決定します。

イベントの関連付けやカスタム アクティビティの検出のために、KQL ではエンティティの種類に応じた複数のパラメーターの入力が必要になります。 それらのパラメーターは対象となるエンティティのさまざまな識別子です。

クエリ結果とエンティティの間に一対一のマッピングを作成するため、強い識別子を選択することをお勧めします。 弱い識別子を選択すると、不正確な結果になるおそれがあります。 [エンティティと強い識別子および弱い識別子の詳細をご確認ください](entities-in-azure-sentinel.md)。

次の表で、エンティティの識別子に関する情報を示します。

**アカウントとホストのエンティティの強い識別子**

クエリには少なくとも 1 つの識別子が必要です。

| Entity | 識別子 | 説明 |
| - | - | - |
| **アカウント** | Account_Sid | Active Directory 内のアカウントのオンプレミス SID |
| | Account_AadUserId | Azure Active Directory 内のユーザーの Azure AD オブジェクト ID |
| | Account_Name + Account_NTDomain | SamAccountName と同様 (例: Contoso\Joe) |
| | Account_Name + Account_UPNSuffix | UserPrincipalName と同様 (例: Joe@Contoso.com) |
| **Host** | Host_HostName + Host_NTDomain | 完全修飾ドメイン名 (FQDN) と同様 |
| | Host_HostName + Host_DnsDomain | 完全修飾ドメイン名 (FQDN) と同様 |
| | Host_NetBiosName + Host_NTDomain | 完全修飾ドメイン名 (FQDN) と同様 |
| | Host_NetBiosName + Host_DnsDomain | 完全修飾ドメイン名 (FQDN) と同様 |
| | Host_AzureID | Azure Active Directory 内のホストの Azure AD オブジェクト ID (AAD ドメイン参加済みの場合) |
| | Host_OMSAgentID | 特定のホストにインストールされているエージェントの OMS エージェント ID (ホストごとに一意) |
|

選択したエンティティに基づいて、使用可能な識別子が表示されます。 関連する識別子をクリックすると、その識別子がクエリ内のカーソルの位置に貼り付けられます。

> [!NOTE]
> - 検出されたアクティビティをエンティティのタイムラインに配置するには、クエリに **TimeGenerated** フィールドが含まれている必要があります。
>
> - クエリでは、**最大 10 個のフィールド** を射影できます。

#### <a name="presenting-the-activity-in-the-timeline"></a>タイムラインでのアクティビティの表示

タイムラインでのアクティビティの表示方法は、使いやすいように自分で決定できます。

`{{ParameterName}}` の形式で、アクティビティの出力に動的パラメーターを追加できます。

次のパラメーターを追加できます。 

- クエリで射影した任意のフィールド  
- Count – このパラメーターを使用すると、KQL クエリの出力カウントを集計できます 
- StartTimeUTC – アクティビティの開始時刻 (UTC) 
- EndTimeUTC – アクティビティの終了時刻 (UTC) 

**例**: "ユーザー `{{TargetUsername}}` がグループ `{{GroupName}}` に `{{SubjectUsername}}` によって追加されました"

### <a name="review-and-create-tab"></a>[確認と作成] タブ 

1. カスタム アクティビティのすべての構成情報を確認します。

1. **[検証に成功しました]** というメッセージが表示されたら、 **[作成]** をクリックしてアクティビティを作成します。 **[自分のアクティビティ]** タブで後からこれを編集または変更できます。

## <a name="manage-your-activities"></a>アクティビティを管理する 

カスタム アクティビティは、 **[自分のアクティビティ]** タブから管理します。アクティビティの行の最後にある省略記号 ([...]) をクリックすると、次の操作を行えます。

- アクティビティを編集する。
- アクティビティを複製して、わずかに異なるものを新しく作成する。
- アクティビティを削除する。
- アクティビティ無効にする (削除はしない)。

## <a name="view-activities-in-an-entity-page"></a>エンティティ ページでアクティビティを表示する

エンティティ ページを表示するたびに、そのエンティティに対して有効になっているすべてのアクティビティ クエリが実行され、そのエンティティのタイムラインに最新の情報が表示されます。 タイムラインには、アクティビティの他にアラートとブックマークも表示されます。 

**[タイムライン コンテンツ]** フィルターを使用すると、アクティビティのみ (またはアクティビティ、アラート、ブックマークの任意の組み合わせ) を表示できます。  

**[アクティビティ]** フィルターを使用して、特定のアクティビティを表示または非表示にすることもできます。 

## <a name="next-steps"></a>次の手順

このドキュメントでは、エンティティ ページのタイムラインにカスタム アクティビティを作成する方法について説明しました。 Azure Sentinel の詳細については、次の記事をご覧ください。
- [エンティティ ページ](identify-threats-with-entity-behavior-analytics.md)の詳細を確認する。
- [エンティティと識別子](entities-reference.md)の完全な一覧を確認する。
