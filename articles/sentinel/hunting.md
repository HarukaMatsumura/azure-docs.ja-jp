---
title: Azure Sentinel の検出機能 | Microsoft Docs
description: Azure Sentinel の組み込みの検索クエリを使用して、データ内の問題を検出するための適切な質問を行うことができます。
services: sentinel
documentationcenter: na
author: yelevin
manager: rkarlin
editor: ''
ms.assetid: 6aa9dd27-6506-49c5-8e97-cc1aebecee87
ms.service: azure-sentinel
ms.subservice: azure-sentinel
ms.devlang: na
ms.topic: conceptual
ms.custom: mvc
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/14/2021
ms.author: yelevin
ms.openlocfilehash: 78662bf6dbc6d4be4f0ea0890993530f772d2114
ms.sourcegitcommit: 0046757af1da267fc2f0e88617c633524883795f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/13/2021
ms.locfileid: "121746234"
---
# <a name="hunt-for-threats-with-azure-sentinel"></a>Azure Sentinel で脅威を検出する

> [!IMPORTANT]
>
> クロスリソース クエリのエクスペリエンスと **ハンティング ダッシュボード** へのアップグレード (以下のマークされた項目を参照) は、現在 **プレビュー** 段階です。 ベータ版、プレビュー版、または一般提供としてまだリリースされていない Azure の機能に適用されるその他の法律条項については、「[Microsoft Azure プレビューの追加使用条件](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)」を参照してください。
>

[!INCLUDE [reference-to-feature-availability](includes/reference-to-feature-availability.md)]

セキュリティ アナリストや調査担当者は、セキュリティ上の脅威を事前に探したいと考えていますが、さまざまなシステムやセキュリティ アプライアンスによって、意味のあるイベントに解析してフィルター処理することが困難なデータが生成されています。 Azure Sentinel には、組織のデータ ソースにわたってセキュリティ上の脅威を検出するための、検出機能を強化した検索とクエリのツールが備わっています。 セキュリティ アプリやスケジュールされた分析ルールで検出されなかった新しい異常をセキュリティ アナリストが事前に探すときに役立つように、Azure Sentinel には検出クエリが組み込まれており、これを通じて、ネットワーク上で既に保有しているデータ内の問題を見つけるために適切な質問を行うことができます。 

たとえば、ある組み込みクエリは、インフラストラクチャ上で実行される最もまれなプロセスに関するデータを提供します。 それらが実行されるたびに警告を受ける必要がないことも、それらがまったく無害である可能性もありますが、時々クエリを調べて、異常なことがないか確認できます。

## <a name="use-built-in-queries"></a>組み込みクエリを使用する

[ハンティング ページ](#use-the-hunting-dashboard-public-preview)には、テーブルやクエリ言語に慣れていただくための、すぐに使えるクエリ例が用意されています。 クエリは、プロセスの作成、DNS イベント、その他のイベントの種類など、ログ テーブル内の格納データに対して実行されます。

組み込みのハンティング クエリは、どちらも Microsoft セキュリティ研究員が新しいクエリを追加し、既存のクエリを修正しながら継続的に開発しているもので、新しく発見された驚異を探し、新しい攻撃のきざしの検出を開始する場所を把握するためのエントリ ポイントになっています。

セキュリティ侵害の前後、あるいは侵害されているときにクエリを使用して、次のアクションを実行します。

- **インシデントが発生する前**: 検出されるのを待っているだけでは不十分です。 ワークスペースに取り込んでいるデータに関連する脅威ハンティング クエリを、少なくとも週 1 回実行することで、プロアクティブな対策を取ります。

    プロアクティブなハンティングによって、セキュリティ侵害が発生していることを確認できるイベントに関する分析情報を早い段階で入手できます。また、少なくとも、環境内のリスクがあり注意が必要な脆弱な領域を把握することができます。

- **セキュリティ侵害中**: [ライブストリーム](livestream.md)を使って特定のクエリを常に実行し、結果を随時表示します。 ライブストリームは、ユーザーのイベントを積極的に監視する必要がある場合に使用します。たとえば、特定のセキュリティ侵害がまだ発生しているかを確認する必要がある場合や、脅威アクターの次のアクションを判断するのを支援する場合、調査の最後に侵害が本当に終わったかどうかを確認する場合などに使用します。

- **セキュリティ侵害後**: 侵害またはインシデントが発生した後で、今後同様のインシデントが発生するのを防ぐために、対象範囲と分析情報を必ず向上させるようにします。

    - 既存のクエリを変更するか新しいクエリを作成し、セキュリティ侵害やインシデントから得た分析情報に基づいて早期検出を支援します。

    - 可能性のある攻撃についての価値のある分析情報を提供するハンティング クエリを発見または作成した場合は、そのクエリに基づいてカスタム検出ルールを作成し、セキュリティ インシデント レスポンダーへのアラートとしてこれらの分析情報を示します。

        クエリの結果を表示し、 **[新しいアラート ルール]**  >  **[Azure Sentinel アラートを生成する]** を選択します。 **[分析ルール ウィザード]** を使用して、ご自身のクエリに基づいて新しいルールを作成します。 詳細については、「[脅威を検出するためのカスタム分析ルールを作成する](detect-threats-custom.md)」を参照してください。


> [!TIP]
> - パブリック プレビューでは、Azure Data Explorer 内の格納データに対して、ハンティング クエリおよびライブストリーム クエリを作成することもできます。 詳細については、Azure Monitor のドキュメントで、[クロスリソース クエリ作成](../azure-monitor/logs/azure-monitor-data-explorer-proxy.md)に関する詳細情報をご覧ください。
>
> - [Azure Sentinel GitHub リポジトリ](https://github.com/Azure/Azure-Sentinel/tree/master/Hunting%20Queries)などのコミュニティ リソースを使用して、追加のクエリとデータ ソースを検索します。
>

## <a name="use-the-hunting-dashboard-public-preview"></a>ハンティング ダッシュボードを使用する (パブリック プレビュー)

ハンティング ダッシュボードを使用すると、1 回選択するだけで、ご自身のクエリをすべて実行したり、特定のサブセットだけを実行したりできます。 Azure Sentinel ポータルで、 **[ハンティング]** を選択します。

テーブルには、Microsoft のセキュリティ アナリスト チームが作成したすべてのクエリと、ご自身が作成または変更した追加クエリが一覧表示されます。 各クエリには、検出の対象と、クエリを実行するデータの種類に関する説明が示されます。 これらのテンプレートは、さまざまな攻撃方法ごとにグループ化されています。右側のアイコンは、初期アクセス、永続性、窃盗などの脅威の種類を分類します。

:::image type="content" source="media/hunting/hunting-start.png" alt-text="Azure Sentinel が検出を開始する" lightbox="media/hunting/hunting-start.png":::

ハンティング ダッシュボードを使用して、結果の件数、急増、24 時間にわたる結果件数の変化を確認し、どこでハンティングを開始するかを特定します。 お気に入りやデータ ソース、MITRE ATT&CK の戦術や手法、結果、結果の差分を基準に並べ替えたりフィルター処理したりすることもできます。 引き続きデータ ソース接続が必要なクエリを確認し、それらのクエリを有効にする方法についての推奨事項を入手できます。

次の表は、ハンティング ダッシュボードから使用できる詳細なアクションについて説明しています。

|アクション  |説明  |
|---------|---------|
|**ご自身の環境にクエリがどのように適用されるかを確認する**     |   **[Run all queries (Preview)]\(すべてのクエリを実行 (プレビュー)\)** ボタンを選択するか、各行の左側にあるチェック ボックスを使ってクエリのサブセットを選択して、 **[Run selected queries (Preview)]\(選択したクエリを実行 (プレビュー)\)** ボタンを選択します。 <br><br>ご自身のクエリの実行には数秒から数分かかることがあります。これは、選択したクエリの数、時間範囲、およびクエリ対象のデータ量によって異なります。      |
|**結果が返されたクエリを表示する**    |      ご自身のクエリの実行が完了したら、 **[結果]** フィルターを使って、結果を返したクエリを確認します。 <br>- どのクエリの結果が最も多かったか、あるいは少なかったかに基づいて並べ替えます。 <br>- **[結果]** フィルター内で *[N/A]* を選択して、ご自身の環境内でまったくアクティブでないクエリを確認します。 <br>- *[N/A]* の横の情報アイコン (**i**) にカーソルを合わせると、そのクエリをアクティブにするために必要なデータ ソースが表示されます。  |
|**データ内の急増を特定する**     |   **[結果の差分]** を基準に並べ替えるかフィルター処理を行って、データ内の急増を特定します。 <br><br>これを使用すると、過去 24 時間の結果がその前の 24 ～ 48 時間の結果と比較され、大きな量の違いが強調表示されます。     |
|**MITRE Att&CK 戦術にマップされたクエリを表示する**     | テーブルの上部にある **MITRE ATT&CK 戦術バー** には、各 MITRE ATT&CK 戦術にマップされるクエリの数が表示されます。 戦術バーは、現在適用されている一連のフィルターに基づいて動的に更新されます。 <br><br>これにより、所定の結果カウント、大きい結果の差分、*N/A* の結果、または他のあらゆるフィルターのセットに従ってフィルター処理したときに、どの MITRE ATT&CK 戦術が表示されるかを確認できます。        |
|**MITRE ATT&CK 手法にマップされたクエリを表示する**     | クエリは、MITRE ATT&CK 手法にマップすることもできます。 **[戦術]** フィルタを使用して、MITRE ATT&CK 戦術でフィルタリングまたはソートすることができます。 クエリを開いて手法を選択すると、その手法の MITRE ATT&CK の説明を確認できます。        |
|**クエリをご自身のお気に入りに保存する**     |   お気に入りに保存したクエリは、 **[ハンティング]** ページにアクセスするごとに自動的に実行されます。 独自の検出クエリまたは複製を作成し、既存の検出クエリ テンプレートをカスタマイズできます。      |
|**クエリを実行する**     |   ハンティング クエリの詳細ページ内で **[クエリの実行]** を選択して、ハンティング ページから直接クエリを実行します。 一致件数がテーブル内の **[結果]** 列に表示されます。 検出クエリとその一致結果の一覧を確認します。     |
|**基になるクエリを確認する**     | 基になるクエリのクイック レビューは、クエリの詳細ウィンドウで実行します。 結果を表示するには、クエリ ウィンドウの下にある **[クエリ結果の表示]** リンク、またはウィンドウの下部にある **[結果の表示]** ボタンをクリックします。 クエリが **[ログ]** (Log Analytics) ブレードで開き、クエリの下でクエリの一致を確認できます。         |
|     |         |


## <a name="create-your-own-bookmarks"></a>独自のブックマークを作成する

ハンティングおよび調査プロセスでは、異常または不審に見えるクエリの結果が見つかることがあります。 これらの項目をブックマークすると、将来、調査用のインシデントを作成または強化するときに参照できます。

- ご自身の結果内で、保持する行のチェックボックスをオンにし、 **[ブックマークの追加]** を選択します。 これにより、マークされた行ごとに、行の結果、結果を作成したクエリ、およびユーザー、ホスト、IP アドレスを抽出するためのエンティティ マッピングを含むレコード (ブックマーク) が作成されます。 各ブックマークには、独自のタグとメモを追加することができます。

- メインの **[ハンティング]** ページの **[ブックマーク]** タブをクリックして、ブックマークされたすべての結果を確認します。 ブックマークにタグを追加して、フィルター処理用に分類します。 たとえば、攻撃活動を調査している場合は、キャンペーンのタグを作成し、そのタグを関連するブックマークに適用して、キャンペーンに基づくすべてのブックマークをフィルター処理できます。

- ブックマークを選択し、詳細ウィンドウで **[調査]** をクリックして調査エクスペリエンスを開くことで、ブックマークした 1 つの検出結果を調査します。

    また、1 つ以上のブックマークからインシデントを作成することも、既存のインシデントに 1 つ以上のブックマークを追加することもできます。 使用するブックマークの左側のチェック ボックスをオンにして、 **[インシデント アクション]**  >  **[新しいインシデントの作成]** または **[既存のインシデントに追加]** を選択します。 他のものと同様に、インシデントをトリアージして調査します。


> [!TIP]
> ブックマークは、注目すべき重要なイベントを表します。調査を必要とするほど深刻なブックマークについては、インシデントにエスカレートする必要があります。 潜在的な根本原因、セキュリティ侵害のインジケーター、その他の注目すべきイベントなどは、ブックマークとして上げてください。
>

詳細については、[ハンティングでのブックマークの使用](bookmarks.md)に関するページをご覧ください。

## <a name="use-notebooks-to-power-investigations"></a>ノートブックを使用して調査を支援する

ノートブックは、独自のカーネルを備えた仮想サンドボックス環境のようなものです。 ノートブックを使用して、機械学習、視覚化、データ分析によって、ハンティングや調査を強化することができます。 ノートブックで完全な調査を実行し、生データ、実行したコード、結果、および資格化をカプセル化して、組織内の他のユーザーに共有して再利用できるように、全体を保存することができます。

詳細については、「[Jupyter Notebook を使用してセキュリティの脅威を検出する](notebooks.md)」を参照してください。


## <a name="useful-operators-and-functions"></a>便利な演算子と関数

ハンティング クエリは、[Kusto クエリ言語 (KQL)](/azure/data-explorer/kusto/query/) で構築されています。これは、ハンティングを次のレベルに引き上げるために必要なパワーと柔軟性を備えた、IntelliSense 言語を使用した強力なクエリ言語です。

これは、分析ルールや Azure Sentinel の他の場所のクエリで使用されている言語と同じものです。 詳細については、[クエリ言語リファレンス](../azure-monitor/logs/get-started-queries.md)をご覧ください。

次の演算子は、Azure Sentinel ハンティング クエリ内で特に役立ちます。

- **where** - テーブルにフィルターが適用され、述語を満たす行のサブセットに絞り込まれます。

- **summarize** - 入力テーブルの内容を集計したテーブルを生成します。

- **join** - 各テーブルの指定の列で値を照合することで、2 つのテーブルの行を結合し、新しいテーブルを形成します。

- **count** - 入力レコード セットに含まれるレコード数を返します。

- **top** - 指定の列で並べ替えられたレコードが先頭から N 個まで返されます。

- **limit** - 最大で指定の行数まで返されます。

- **project** - 含める列、名前を変更する列、または削除する列を選択し、新しい計算列を挿入します。

- **extend** - 計算列を作成し、それらを結果セットに追加します。

- **makeset** - グループ内である式により受け取られる個別値セットを dynamic (JSON) 配列で返します

- **find** - テーブルのセットで述語が一致する行を検索します。

- **adx () (プレビュー)** - この関数は、Azure Sentinel ハンティング エクスペリエンスと Log Analytics から、Azure Data Explorer データ ソースのクロスリソース クエリを実行します。 詳細については、「[Azure Monitor を使用した Azure Data Explorer のクロスリソース クエリ](../azure-monitor/logs/azure-monitor-data-explorer-proxy.md)」をご覧ください。

## <a name="save-a-query"></a>クエリを保存する

クエリを作成または変更し、独自のクエリとして保存するか、同じテナントに属しているユーザーと共有します。

:::image type="content" source="./media/hunting/save-query.png" alt-text="クエリを保存する" lightbox="./media/hunting/save-query.png":::

**新しいクエリを作成するには**:

1. **[新しいクエリ]** を選択します。

1. すべての空フィールドに入力し、 **[作成]** を選択します。

    :::image type="content" source="./media/hunting/new-query.png" alt-text="新しいクエリ" lightbox="./media/hunting/new-query.png":::

**既存のクエリを複製および変更するには**:

1. 変更するテーブル内の検出クエリを選択します。

1. 変更するクエリの行で省略記号 (...) を選択し、 **[クエリの複製]** を選択します。

    :::image type="content" source="./media/hunting/clone-query.png" alt-text="クエリの複製" lightbox="./media/hunting/clone-query.png":::

1. クエリを変更し、 **[作成]** を選択します。

    :::image type="content" source="./media/hunting/custom-query.png" alt-text="カスタム クエリ" lightbox="./media/hunting/custom-query.png":::



## <a name="sample-query"></a>サンプル クエリ

一般的なクエリではテーブル名を最初に記述し、その後に一連の演算子を \| で区切って続けます。

上記の例では、テーブル名 SecurityEvent を最初に記述し、必要に応じてパイプでつないで要素を追加します。

1. 時間のフィルターを定義して、直近の 7 日間のレコードだけを確認するようにします。

1. イベント ID 4688 のみを表示するようにクエリにフィルターを追加します。

1. cscript.exe のインスタンスのみを含めるように、コマンドラインでクエリにフィルターを追加します。

1. 探索に関心がある列だけを見積もり、結果を 1,000 に制限して、 **[クエリの実行]** を選択します。

1. 緑の三角形を選択して、クエリを実行します。 クエリをテストし、クエリを実行して異常な動作を調べられます。

## <a name="next-steps"></a>次のステップ

この記事では、Azure Sentinel で検出調査を実行する方法を学習しました。 

詳細については、次を参照してください。

- [ノートブックを使用して自動化された検出キャンペーンを実行する](notebooks.md)
- [ブックマークを使用して検出中に関心のある情報を保存する](bookmarks.md)

[カスタム コネクタ](create-custom-connector.md)で [Zoom を監視](https://techcommunity.microsoft.com/t5/azure-sentinel/monitoring-zoom-with-azure-sentinel/ba-p/1341516)するときのカスタム分析ルールの使用例をご覧ください。

