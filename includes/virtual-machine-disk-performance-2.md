---
title: インクルード ファイル
description: インクルード ファイル
services: virtual-machines
author: albecker1
ms.service: virtual-machines
ms.topic: include
ms.date: 10/12/2020
ms.author: albecker1
ms.custom: include file
ms.openlocfilehash: f5ac97812f973a20f6ee4c2dea34baaeb91203af
ms.sourcegitcommit: 2c586a0fbec6968205f3dc2af20e89e01f1b74b5
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/14/2020
ms.locfileid: "92016469"
---
![Dsv3 ドキュメント](media/vm-disk-performance/dsv3-documentation.jpg)

**キャッシュされない**ディスクの最大スループットは、仮想マシンが処理できる既定のストレージの上限になります。 **キャッシュされる**ストレージのスループットの上限は、ホストキャッシュを有効にすると、別個の制限になります。 ホスト キャッシュは、書き込みまたは読み取りを迅速に実行できるストレージを VM の近くに配置することで機能します。 ホスト キャッシュ用に VM で使用できるストレージの容量は、ドキュメントに記載されています。 たとえば、Standard_D8s_v3 には 200 GiB のキャッシュ ストレージが備わっていることがわかります。

ホスト キャッシュの有効化は、仮想マシンを作成してディスクを接続するときに実行できます。 また、既存の VM 上のディスクに対するホスト キャッシュをオンまたはオフにするように調整することもできます。

![ホスト キャッシュ](media/vm-disk-performance/host-caching.jpg)

各ディスクのワークロードの要件に合うようにホスト キャッシュを調整できます。 読み取り操作のみが行われるワークロードでは読み取り専用になるように、読み取り操作と書き込み操作が同程度行われるワークロードでは読み取り/書き込みになるように、ホスト キャッシュを設定できます。 ワークロードがこれらのパターンのいずれにも該当しない場合は、ホスト キャッシュを使用することはお勧めしません。 

さまざまなホスト キャッシュ設定の例をいくつか紹介し、データ フローとパフォーマンスにどのように影響するかを見てみましょう。 この最初の例では、ホスト キャッシュ設定が**読み取り専用**に設定されている場合の IO 要求の処理について説明します。

設定: 
- Standard_D8s_v3 
    - キャッシュされる IOPS:16,000
    - キャッシュされない IOPS:12,800
- P30 データ ディスク 
    - IOPS:5,000
    - **ホスト キャッシュ:読み取り専用** 

読み取りが実行されたとき、必要なデータがキャッシュで利用可能になっている場合は、要求されたデータがキャッシュから返されます。ディスクから読み取る必要はありません。 この読み取りは、VM のキャッシュ制限にカウントされます。

![読み取りホスト キャッシュの読み取りヒット](media/vm-disk-performance/host-caching-read-hit.jpg)

読み取りが実行されたとき、必要なデータがキャッシュで利用可能になって**いない**場合は、読み取り要求がディスクに中継され、そこからキャッシュと VM の両方に返されます。 この読み取りは、VM の未キャッシュ制限と VM のキャッシュ制限の両方にカウントされます。

![読み取りホスト キャッシュの読み取りミス](media/vm-disk-performance/host-caching-read-miss.jpg)

書き込みが実行された場合、書き込みが完了したと見なされるには、キャッシュとディスクの両方に書き込まれている必要があります。 この書き込みは、VM の未キャッシュ制限と VM のキャッシュ制限にカウントされます。

![読み取りホスト キャッシュの書き込み](media/vm-disk-performance/host-caching-write.jpg)

この次の例では、ホスト キャッシュ設定が**読み取り/書き込み**に設定されている場合の IO 要求の処理について説明します。

設定: 
- Standard_D8s_v3 
    - キャッシュされる IOPS:16,000
    - キャッシュされない IOPS:12,800
- P30 データ ディスク 
    - IOPS:5,000
    - **ホスト キャッシュ:読み取り/書き込み** 

読み取りは、読み取り専用とまったく同じ方法で処理されます。読み取り/書き込みキャッシュでは、書き込みだけが異なります。 ホスト キャッシュが読み取り/書き込みに設定されている場合の書き込みでは、ホスト キャッシュに書き込まれただけで、書き込みが完了したと見なされます。 その後、書き込みはバックグラウンド プロセスとしてディスクに遅延書き込みされます。 つまり、書き込みは、キャッシュに書き込まれたときにキャッシュ IO にカウントされ、ディスクに遅延書き込みされたときに未キャッシュ IO にカウントされます。

![読み取り/書き込みホスト キャッシュの書き込み](media/vm-disk-performance/host-caching-read-write.jpg)

Standard_D8s_v3 仮想マシンの例で説明を続けましょう。 今回以外は、ディスクでホスト キャッシュを有効にし、現在 VM の IOPS 制限は 16,000 IOPS になっています。 VM に接続されているのは、5,000 IOPS を処理できる 3 台の下部 P30 ディスクです。

設定: 
- Standard_D8s_v3 
    - キャッシュされる IOPS:16,000
    - キャッシュされない IOPS:12,800
- P30 OS ディスク 
    - IOPS:5,000
    - ホスト キャッシュ:読み取り/書き込み 
- 2 台の P30 データ ディスク
    - IOPS:5,000
    - ホスト キャッシュ:読み取り/書き込み

![ホスト キャッシュの例](media/vm-disk-performance/host-caching-example-without-remote.jpg)

ここで、このキャッシュが有効になっている Standard_D8s_v3 仮想マシンを使用するアプリケーションで、15,000 IOPS の要求を行ったとします。 この要求は、接続されている下部ディスクごとの 5,000 IOPS として分解され、パフォーマンスの上限が発生することはありません。

## <a name="combined-uncached-and-cached-limits"></a>未キャッシュ制限とキャッシュ制限の組み合わせ

仮想マシンのキャッシュ制限と未キャッシュ制限は切り離されています。 これは、仮想マシンでキャッシュ制限に未キャッシュ制限を加えた合計ストレージ IO を取得できるように、VM に接続されているディスクでホスト キャッシュを有効にすると同時に他のディスクでホスト キャッシュを有効にしないことが可能であることを意味します。 これらの制限がどのように連携するかを例を用いて説明しましょう。Premium ディスクが接続された Standard_D8s_v3 仮想マシンの構成で説明を続けます。

設定: 
- Standard_D8s_v3 
    - キャッシュされる IOPS:16,000
    - キャッシュされない IOPS:12,800
- P30 OS ディスク 
    - IOPS:5,000
    - ホスト キャッシュ:読み取り/書き込み
- 2 台の P30 データ ディスク
    - IOPS:5,000
    - ホスト キャッシュ:読み取り/書き込み
- 2 台の P30 データ ディスク
    - IOPS:5,000
    - ホスト キャッシュ:無効

![リモート ストレージを使用するホスト キャッシュの例](media/vm-disk-performance/host-caching-example-with-remote.jpg)

Standard_D8s_v3 仮想マシンで実行されているアプリケーションで、25,000 IOPS の要求を行ったとします。 この要求は、接続されている下位ディスクごとの 5,000 IOPS として分解されますが、これらのディスクのうち 3 台でホスト キャッシュが使用され、2 台のディスクで使用されていません。 ホスト キャッシュを使用している 3 台ではキャッシュ制限である 16,000 の範囲内にあるため、これらの要求は正常に完了し、ストレージ パフォーマンスの上限が発生することはありません。 同様に、ホスト キャッシュを使用していない 2 台のディスクでは、未キャッシュ制限である 12,800 の範囲内にあるため、これらの要求も正常に完了し、上限が発生することはありません。

## <a name="metrics-for-disk-performance"></a>ディスクのパフォーマンスのメトリック
Azure には、仮想マシンとディスクのパフォーマンスに関する分析情報を提供するメトリックが用意されています。 これらのメトリックは、Azure portal を通じて視覚的に表示することも、API 呼び出しを通じて取得することもできます。 メトリックは 1 分間隔で計算されます。 次のメトリックを使用して、VM、ディスク IO、およびスループットのパフォーマンスに関する分析情報を取得できます。
- **OS ディスクのキューの深さ** – OS ディスクに対する読み取りまたは書き込みのために待機している現在の未処理 IO 要求の数。
- **OS ディスク読み取りバイト数/秒** – OS ディスクから 1 秒間に読み取られるバイトの数。
- **OS ディスク読み取り操作数/秒** – OS ディスクから 1 秒間に読み取られる入力操作の数。
- **OS ディスク書き込みバイト数/秒** – OS ディスクから 1 秒間に書き込まれるバイトの数。
- **OS ディスク書き込み操作数/秒** – OS ディスクから 1 秒間に書き込まれる出力操作の数。
- **データ ディスクのキューの深さ** – データ ディスクに対する読み取りまたは書き込みのために待機している現在の未処理 IO 要求の数。
- **データ ディスク読み取りバイト数/秒** – データ ディスクから 1 秒間に読み取られるバイトの数。
- **データ ディスク読み取り操作数/秒** – データ ディスクから 1 秒間に読み取られる入力操作の数。
- **データ ディスク書き込みバイト数/秒** – データ ディスクから 1 秒間に書き込まれるバイトの数。
- **データ ディスク書き込み操作数/秒** – データ ディスクから 1 秒間に書き込まれる入力操作の数。
- **ディスク読み取りバイト数/秒** – VM に接続されているすべてのディスクから 1 秒間に読み取られるバイトの合計数。
- **ディスク読み取り操作数/秒** – VM に接続されているすべてのディスクから 1 秒間に読み取られる入力操作の数。
- **ディスク書き込みバイト数/秒** – VM に接続されているすべてのディスクから 1 秒間に書き込まれるバイトの数。
- **ディスク書き込み操作数/秒** – VM に接続されているすべてのディスクから 1 秒間に書き込まれる出力操作の数。

## <a name="storage-io-utilization-metrics"></a>ストレージ IO 使用率メトリック
ディスク IO の上限の診断に役立つメトリック:
- **データ ディスク IOPS の消費率** - プロビジョニングされたデータ ディスク IOPS に対する完了済みのデータ ディスク IOPS で計算された割合。 この量が 100% の場合、実行しているアプリケーションで、データ ディスクの IOPS 制限からの IO 上限が発生します。
- **データ ディスク帯域幅の消費率** - プロビジョニングされたデータ ディスクのスループットに対する完了済みのデータ ディスクのスループットで計算された割合。 この量が 100% の場合、実行しているアプリケーションで、データ ディスクの帯域幅制限からの IO 上限が発生します。
- **OS ディスク IOPS の消費率** - プロビジョニングされた OS ディスクの IOPS に対する完了済みの OS ディスクの IOPS で計算された割合。 この量が 100% である場合、実行しているアプリケーションで、OS ディスクの IOPS 制限からの IO 上限が発生します。
- **OS ディスク帯域幅の消費率** - プロビジョニングされた OS ディスクのスループットに対する完了済みの OS ディスクのスループットで計算された割合。 この量が 100% である場合、実行しているアプリケーションで、OS ディスクの帯域幅制限からの IO 上限が発生します。

VM の IO 上限の診断に役立つメトリック:
- **VM のキャッシュあり IOPS の消費率** - 仮想マシンのキャッシュあり IOPS の上限に対する完了済みの合計 IOPS で計算された割合。 この量が 100% の場合、実行しているアプリケーションで、VM の キャッシュあり IOPS 制限からの IO 上限が発生します。
- **VM のキャッシュあり帯域幅の消費率** - 仮想マシンのキャッシュあり最大スループットに対する完了済みの合計ディスク スループットで計算された割合。 この量が 100% である場合、実行しているアプリケーションで、VM のキャッシュあり帯域幅制限からの IO 上限が発生します。
- **VM のキャッシュなし IOPS の消費率** - 仮想マシンのキャッシュなし IOPS の上限に対する仮想マシンの完了済みの合計 IOPS で計算された割合。 この量が 100% の場合、実行しているアプリケーションで、VM の キャッシュなし IOPS 制限からの IO 上限が発生します。
- **VM のキャッシュなし帯域幅の消費率** - 仮想マシンのプロビジョニングされた最大スループットに対する仮想マシンの完了済みの合計ディスク スループットで計算された割合。 この量が 100% である場合、実行しているアプリケーションで、VM のキャッシュなし帯域幅制限からの IO 上限が発生します。

## <a name="storage-io-utilization-metrics-example"></a>ストレージ IO 使用率メトリックの例
これらの新しいストレージ IO 使用率メトリックを使用して、システム内でボトルネックが発生している箇所をデバッグする方法の例を見てみましょう。 システムのセットアップは、前の例で使用したものとまったく同じです。ただし、今回接続した OS ディスクはキャッシュされて**いません**。

設定: 
- Standard_D8s_v3 
    - キャッシュされる IOPS:16,000
    - キャッシュされない IOPS:12,800
- P30 OS ディスク 
    - IOPS:5,000
    - ホスト キャッシュ:無効
- 2 台の P30 データ ディスク
    - IOPS:5,000
    - ホスト キャッシュ:読み取り/書き込み
- 2 台の P30 データ ディスク
    - IOPS:5,000
    - ホスト キャッシュ:無効

